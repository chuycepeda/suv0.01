{% extends 'admin_base.html' %}

{% block breadcrums %}
    <!--breadcrumbs start-->
    <div id="breadcrumbs-wrapper" class=" grey lighten-3" style="  min-height: 70px;">
        <div class="container">
            <div class="row">
              <div class="col s12 m12 l12">
                <h5 class="breadcrumbs-title">Mapa de reportes</h5>
              </div>
            </div>
        </div>
    </div>
    <!--breadcrumbs end-->
{% endblock %}

{% block page_css %}
    <style>
        .btn{
                margin-right: 10px;
        }
    </style>
    <link rel="stylesheet" href="/{{theme}}/materialize/css/cartodb.css">
{% endblock %}

{% block page_content %}
    <div class="row">
            <div style="height:600px; width:100%;">
                    <div id="map" style="height:100%; width:100%;"> </div>
            </div>
            <div class="hide-on-small-only" style="position:fixed; width:270px; top:120px; left:15%;">
                <ul class="collapsible collapsible-accordion" data-collapsible="expandable">
                  <li>
                    <div class="collapsible-header white-text truncate brand-color" style="background-color: {{brand_secondary_color}}!important;"> <i class="mdi-navigation-arrow-drop-down"></i> Estás viendo <span id="rep_count" style="font-family: roboto-regular;">0</span> reportes.</div>
                            <div class="collapsible-body white">
                                <p style="padding: 8px;">
                                    <input type="checkbox" class="filled-in layerControl" id="check_alcalde" checked>
                                    <label for="check_alcalde">Vía {{app_name}}: <span style="color:#4EC8BC" id="c_alcalde"></span></label>
                                </p>
                                {% if cartodb_has_cic %}
                                <p style="padding: 8px;">
                                    <input type="checkbox" class="filled-in layerControl" id="check_cic_M">
                                    <label for="check_cic_M">Vía CIC: <span style="color:#43D1EC" id="c_cic_M"></span></label>
                                </p>
                                {% endif %}
                            </div>
                  </li>
                  <li>
                    <div class="collapsible-header white-text brand-color" style="background-color: {{brand_secondary_color}}!important;"><i class="mdi-device-dvr"></i> Cambiar vista</div>
                    <div class="collapsible-body white lighten-5 center">
                      <div class="row">
                        <div class="col s6" style="margin-top:15px;"><a class="btn-floating btn-large waves-effect waves-light green tooltipped" data-position="top" data-delay="50" data-tooltip="Normal" onclick="setMapView('normal');"><i class="mdi-maps-place"></i></a></div>
                        <div class="col s6" style="margin-top:15px;"><a class="btn-floating btn-large waves-effect waves-light yellow tooltipped" data-position="top" data-delay="50" data-tooltip="Agrupado" onclick="setMapView('cluster');"><i class="mdi-maps-pin-drop"></i></a></div>
                      </div>
                      <div class="row">
                        <div class="col s6"><a class="btn-floating btn-large waves-effect waves-light red tooltipped" data-position="top" data-delay="50" data-tooltip="Intensidad" onclick="setMapView('heat');"><i class="mdi-social-whatshot"></i></a></div>
                        <div class="col s6"><a class="btn-floating btn-large waves-effect waves-light light-blue tooltipped" data-position="top" data-delay="50" data-tooltip="Recurrencia" onclick="setMapView('intensity');"><i class="mdi-image-blur-circular"></i></a></div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="collapsible-header white-text brand-color" style="background-color: {{brand_secondary_color}}!important;"><i class="mdi-content-filter-list"></i> Filtrar</div>
                    <div class="collapsible-body white lighten-5">
                        
                        <div class="row">
                            <div class="container">
                                <div class="input-field col s12">
                                    <button class="waves-effect waves-light btn filterbtn col s12" id="statusfilterbtn">Status</button>
                                    <button class="waves-effect waves-light btn filterbtn col s12" id="categoryfilterbtn" disabled>Categorias</button>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col s10 offset-s1" style="margin-top:15px;">
                                <div class="switch">
                                    Fechas : 
                                    <label>
                                        Off
                                        <input type="checkbox" class="filterControl" id="calendar">
                                        <span class="lever"></span> On
                                    </label>
                                </div>
                                <div class="input-field col s6">
                                    <input id="from" type="date" class="datepicker filterControl" disabled>
                                    <label for="from" style="background-color: transparent!important;">Desde</label>
                                </div>
                                <div class="input-field col s6">
                                    <input id="until" type="date" class="datepicker filterControl" disabled>
                                    <label for="until" style="background-color: transparent!important;">Hasta</label>
                                </div>                    
                            </div>
                        </div>
                        <div class="row center grey-text" style="    margin-bottom: 10px;">
                            <div class="input-field col s12">
                                <span><a class="btn-floating waves-effect waves-light red" id='removeFilter'><i class="mdi-content-clear"></i></a></span>
                                <span style="padding-left: 5px; vertical-align: middle; text-transform: uppercase;">Remover filtros</span>
                            </div>
                        </div>
                                        
                    </div>
                  </li>
                </ul>
            </div>  
            <div id="modal3" class="modal" style="top: 80px!important; font-family: roboto-medium; max-height: 85%;">
              <i class="mdi-navigation-close brand-color-text right modal-action modal-close" style="padding: 10px;"></i>
              <div id="modal3_content" class="modal-content brand-color-text row" style="overflow-y:scroll;">
                <div class="row">
                    <img id="report_image" class="responsive-img center col s12 m6" style="margin-top: 12px;" src="" style="display:none;">
                    <div id="gSV" class="col s12" style="display:none;">
                        <div id='gSVpanorama' style='height: 300px;overflow: hidden;-webkit-transform: translateZ(0px); background-color:{{brand_secondary_color}}'></div>
                    </div>
                </div>
                <p class="col s12 m4"><i style="padding:8px;" class="mdi-action-receipt brand-color-text"></i>Ticket: <span id="report_cartodb_id" class="brand-secondary-color-text"></span></p>
                <p class="col s12 m4"><i style="padding:8px;" class="mdi-action-book brand-color-text"></i>Estado: <span id="report_status" class="brand-secondary-color-text"></span></p>
                <p class="col s12 m4"><i style="padding:8px;" class="mdi-social-group-add brand-color-text"></i>Seguidores: 
                <span id="report_followers" class="brand-secondary-color-text"></span>
                {% if user_id %}
                <a href="#" id="followBtn" class="waves-effect waves-white btn brand-color modal-action tooltipped small" data-position="top" data-delay="50" data-tooltip="Seguir este reporte te permite ver su historial de cambios y sumarte a la conversación."   style="margin-left:18px;    margin-left: 18px;font-size: 12px;padding-left: 10px;padding-right: 10px;" onclick="followReport(this)">Seguir</a>
                {% else %}
                    <a href="{{ uri_for('login') }}" class="modal-trigger menu-item waves-effect waves-white btn brand-color modal-action tooltipped small" data-position="top" data-delay="50" data-tooltip="Seguir este reporte te permite ver su historial de cambios y sumarte a la conversación." style="margin-left:18px;    margin-left: 18px;font-size: 12px;padding-left: 10px;padding-right: 10px;" >Seguir</a></li>
                {% endif %}
                </p>
                <p class="col s12 m4"><i style="padding:8px;" class="mdi-action-event brand-color-text"></i>Fecha: <span id="report_date" class="brand-secondary-color-text"></span></p>
                <p class="col s12 m8"><i style="padding:8px;" class="mdi-maps-pin-drop brand-color-text"></i>Dirección: <span id="report_address" class="brand-secondary-color-text"></span></p>
                <p class="col s12 m4"><i style="padding:8px;" class="mdi-action-group-work brand-color-text"></i>Grupo: <span id="report_group_category" class="brand-secondary-color-text"></span></p>
                <p class="col s12 m4"><i style="padding:8px;" class="mdi-image-style brand-color-text"></i>Categoría: <span id="report_sub_category" class="brand-secondary-color-text"></span></p>
                <p class="col s12"><i style="padding:8px;" class="mdi-action-description brand-color-text"></i>Descripción: <span id="report_description" class="brand-secondary-color-text"></span></p>
                <p class="col s12" style="margin-left:10px;">Cambios y comentarios: <br><span id="report_comments" style="color:#53ACA8!important"></span></p>
                {% if user_id %}
                <div class="row">
                    <div class="input-field col s11 offset-s1 m7 offset-m1">
                        <textarea id="commentbox" name="commentbox" class="materialize-textarea" length="500" style="height: 22px;" type="text" ></textarea>
                        <label for="commentbox">Agrega tu comentario aquí...</label>
                    </div>
                    <div class="input-field col s11 offset-s1 m7 offset-m1">
                        <a class="btn waves-effect waves-light sm-green white-text right" style="cursor:pointer;" id="submit_report_form_comment">Comentar <i class="mdi-content-send right"></i></a>
                    </div>
                </div> 
                {% endif %}
                <input id="report_ticket" type="hidden" value="">
                <input id="report_follows" type="hidden" value="">
              </div>
              <div class="modal-footer brand-tertiary-color">               
                <a href="#" class="waves-effect waves-teal btn-flat modal-action modal-close white-text" style="margin-right:20px;">Cerrar</a>
              </div>
            </div>
    </div>
    
    <!-- MODALS FOR FILTERS -->
    <!-- FOR STATUS -->
    <div id="modalstatusfilterbtn" class="modal">
        <i class="mdi-navigation-close brand-color-text right modal-action modal-close" style="padding: 10px;"></i>
        <div class="modal-content" id= "statusfilterContainer">
            
            <div class="row">
                <div class="col s12">
                    <div class="card-panel">
                        <span class="card-title">
                            <span style="font-size: 30px;">Selecciona un estado</span>
                        </span>
                        <div class="row">
                            <p class="col s12 m4"><input class="filterControl filterStatus" type="checkbox" id="halted"><label for="halted">En espera</label></p>
                            <p class="col s12 m4"><input class="filterControl filterStatus" type="checkbox" id="answered"><label for="answered">Respondido</label></p>
                            <p class="col s12 m4"><input class="filterControl filterStatus" type="checkbox" id="assigned"><label for="assigned">Asignado</label></p>
                            <p class="col s12 m4"><input class="filterControl filterStatus" type="checkbox" id="solved"><label for="solved">Resuelto</label></p>                                                                                                                                                      
                            <p class="col s12 m4"><input class="filterControl filterStatus" type="checkbox" id="rejected"><label for="rejected">Rechazado</label></p>
                            <p class="col s12 m4"><input class="filterControl filterStatus" type="checkbox" id="archived"><label for="archived">Archivado</label></p>                                                                                                                                                  
                            <p class="col s12 m4"><input class="filterControl filterStatus" type="checkbox" id="working"><label for="working">En proceso</label></p>
                            <p class="col s12 m4"><input class="filterControl filterStatus" type="checkbox" id="failed "><label for="failed ">Fallo</label></p>                                                                                                                                                      
                            <p class="col s12 m4"><input class="filterControl filterStatus" type="checkbox" id="open"><label for="open">Abierto</label></p>         
                            <p class="col s12 m4"><input class="filterControl filterStatus" type="checkbox" id="spam"><label for="spam">Spam</label></p>            
                            <p class="col s12 m4"><input class="filterControl filterStatus" type="checkbox" id="forgot"><label for="forgot">Olvidado</label></p>
                        </div>
                    </div>
                </div>
            </div>
        
        </div>
    </div>            
    <!-- FOR CATEGORIES AND SUBS -->
    <div id="modalcategoryfilterbtn" class="modal">
        <i class="mdi-navigation-close brand-color-text right modal-action modal-close" style="padding: 10px;"></i>
        <div class="modal-content" id="categoryfilterContainer"></div>
    </div> 
{% endblock %}

{% block page_floatings %}
{% endblock %}

{% block page_scripts %}
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=drawing,places,panoramio,weather,visualization"></script>
    <script src="/{{theme}}/materialize/js/cartodb.js"></script>
    {% if not cartodb_has_cic %}
                    <script type="text/javascript">
                        // cartodb
                        var city_user = '{{cartodb_user}}';
                        var city_table_name = '{{cartodb_reports_table}}';
                        var city_mun_table_name = '{{cartodb_polygon_table}}';
                        var city_polygon_name = '{{cartodb_polygon_name}}'
                        var city_sql = new cartodb.SQL({ user: '{{cartodb_user}}' });
                        var sublayers = [];
                        var zoned = false;
                        var sourceurl = "{{cartodb_markers_url}}";
                        var city_catMarkers = [];
                        var reportDict;

                        function allTrue(arr) {
                          for(var i = 0, j = arr.length; i<j; i++)
                              if(!arr[i]) return false;
                          return true;
                        }
                        
                        function singleCheck(arr) {
                          var cont = 0;
                          for(var i = 0, j = arr.length; i<j; i++){
                             if(arr[i].checked) cont++;
                             if (cont > 1) return 0; 
                          }
                          return cont;
                        }
                        
                        function catFilter(dict){
                            var container = document.getElementById("categoryfilterContainer");
                            var html='';
                            for (var x in dict){
                                if (!allTrue(dict[x].pf)){
                                    html += '<div class="row"><div class="col s12"><div class="card-panel"><span class="card-title"><input class="filterControl filterGroup" type="checkbox" id="'+x+'"><label for="'+x+'"><span style="font-size: 30px;">'+x+'</span></label></span><div class="row">';
                                    for (var i = 0, j = dict[x].categories.length; i<j; i++){
                                        if (!dict[x].pf[i]){
                                            html += '<p class="col s12 m4"><input class="filterControl filterCategory" type="checkbox" id="'+dict[x]['categories'][i]+'"><label for="'+dict[x]['categories'][i]+'">'+dict[x]['categories'][i]+'</label></p>';
                                        }
                                    }
                                    html += '</div></div></div></div>';
                                }
                            }     
                            container.innerHTML = html;
                            $('#categoryfilterbtn').attr('disabled',false);
                            $('.filterControl').change(function() { Q(); });

                        }
                        
                        /* MAPS RELATED */
                        var panorama, sv = new google.maps.StreetViewService();
                        var mapCenter = [{{lat}},{{lng}}] , map;
                        google.maps.event.addDomListener(window,'load', init);
                        var query;                    
                        
                        
                        function init(){
                            var mapOptions = {
                                center: new google.maps.LatLng(mapCenter[0], mapCenter[1]),
                                zoom: {% if is_mobile %}11{% else %}12{% endif %},
                                minZoom:5,
                                zoomControl: true,
                                zoomControlOptions: {
                                    style: google.maps.ZoomControlStyle.SMALL,  
                                    position: google.maps.ControlPosition.LEFT_BOTTOM   
                                },
                                mapTypeControl: false,
                                scrollwheel: false,
                                streetViewControl: true,
                                streetViewControlOptions: {
                                    position: google.maps.ControlPosition.LEFT_BOTTOM   
                                },
                                panControl:false,
                                backgroundColor: 'rgb(249, 249, 249)',
                                rotateControl:true,
                                overviewMapControl:true
                            };
                            map = new google.maps.Map(document.getElementById('map'), mapOptions);
                            
                            google.maps.event.addDomListener(window, 'resize', function() {
                                map.setCenter({lat: mapCenter[0], lng: mapCenter[1]});
                            });

                            var autocomplete_from = new google.maps.places.Autocomplete(document.getElementById('search_address'))
                            autocomplete_from.bindTo('bounds', map);
                            google.maps.event.addListener(autocomplete_from, 'place_changed', function() {
                                var place = autocomplete_from.getPlace();
                                if (place.geometry.viewport) {
                                  map.fitBounds(place.geometry.viewport);
                                }else{
                                  map.setCenter(place.geometry.location);
                                  map.setZoom(17);
                                }
                            }); 

                            var centerControlDiv = document.createElement('div');
                            var centerControl = new CenterControl(centerControlDiv, map);
                            centerControlDiv.index = 1;
                            map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(centerControlDiv);
                               

                            // CITY LAYERS
                            var city_query= "SELECT * FROM " + city_table_name + " WHERE status not in ('spam', 'archived', 'forgot') AND pvt = false";     
                            var city_interactivity = ["cartodb_id", "group_category", "sub_category", "via", "description", "_when", "address_from", "folio", "follows", "rating", "status", "image_url", "via", "title"];
                            $.ajax({
                                url: "{{ uri_for('materialize-report-categories') }}",
                                type: 'GET'
                            }).done(function(data) {
                                reportDict = data;
                                catFilter(reportDict);
                                for (var x in reportDict){
                                    for (var y in reportDict[x].icon_url){
                                        city_catMarkers.push([y, reportDict[x].icon_url[y], reportDict[x].color]);
                                    }
                                }
                                layerSource = {
                                    user_name: city_user,
                                    type: 'cartodb',
                                    sublayers: [{
                                        sql: "SELECT " + city_mun_table_name + ".* FROM " + city_mun_table_name + " WHERE " + city_mun_table_name + ".name IN ('" + city_polygon_name + "')",
                                        cartocss: "#" + city_mun_table_name + "{line-color: #EB332C;line-width: 2;line-opacity: 1;}"

                                    },{
                                        sql: city_query,
                                        cartocss: createTileStyle('normal',city_table_name),
                                        interactivity: city_interactivity
                                    }]
                                };
                                cartodb.createLayer(map,layerSource)
                                .on('done', function(layer) {
                                    map.overlayMapTypes.setAt(0, layer);
                                    for (var i = 0; i < layer.getSubLayerCount(); i++) {
                                       sublayers[i] = layer.getSubLayer(i);
                                       console.log("Congrats, you added sublayer #" + i + "!");
                                    }

                                    sublayers[1].infowindow.set('template', $('#infowindow_'+city_table_name).html());
                                    cdb.vis.Vis.addInfowindow(map, sublayers[1], city_interactivity, {
                                        infowindowTemplate: $('#infowindow_'+city_table_name).html()
                                    });
                                    sublayers[1].setInteraction(true);                                 
                                    sublayers[1].on('featureClick', function(e, latlng, pos, data) {
                                          populateModal(data, latlng);
                                    });  
                                    
                                   city_sql.execute(city_query).done(function(data) {
                                            $('#rep_count').html(addCommas(data.total_rows));
                                            $('#rep_count_M').html(addCommas(data.total_rows));
                                            $('#c_alcalde').html(data.total_rows);
                                            $('#c_alcalde_M').html(data.total_rows);
                                    });

                                    var obj = getUrlVars();
                                    if (obj.cdb_id){
                                        var query = "select st_y(the_geom) as lat, st_x(the_geom) as lon, cartodb_id, _when, address_from, description, folio, follows, group_category, image_url, rating, status, sub_category, title, via from "+city_table_name+" where cartodb_id = " + obj.cdb_id;
                                        city_sql.execute(query).done(function(data) {
                                            if(data.total_rows >= 1) {
                                                 populateModal(data.rows[0], [data.rows[0].lat, data.rows[0].lon]);
                                                 map.setZoom(21);
                                            }
                                        })
                                    }
                                }); 
                            });
                            
                            //FILTER RELATED LISTENERS
                            $('#calendar').change( function() {
                                $('#from').attr('disabled',!this.checked);
                                $('#until').attr('disabled',!this.checked);
                            });
                                                                        
                            $('.filterbtn').on('click', function() {
                                $('#modal'+this.id).openModal();
                            });
        
                            $('.layerControl').change(function() {
                                var add=0;
                                if (this.id == 'check_alcalde'){
                                    if (this.checked) sublayers[1].show();
                                    else sublayers[1].hide();
                                }
                                
                                add += document.getElementById('check_alcalde').checked ? Number($('#c_alcalde').html()) : 0;

                                $('#rep_count').html(addCommas(add));
                                $('#rep_count_M').html(addCommas(add));                        
                            });
                            
                            $('#removeFilter').on('click', function() {
                                $('.filterControl').prop('checked',false);
                                Q();
                            });
                            setTimeout(function(){
                              $('#right-sidebar-nav').hide();
                            }, 10000);
                        }

                        function codeAddress(input) {
                            var address, obj;                               

                            address = document.getElementById(input).value;
                            obj = { 'address': address };
                            geocoder.geocode( obj, function(results, status) {
                                if (status == google.maps.GeocoderStatus.OK) {
                                    
                                    if (typeof(input) === 'string') {
                                        map.setCenter(results[0].geometry.location);
                                        switch (results[0].geometry.location_type){
                                            case 'ROOFTOP': map.setZoom(17); break;
                                            case 'RANGE_INTERPOLATED': map.setZoom(16); break;
                                            case 'GEOMETRIC_CENTER': map.setZoom(15); break;
                                            case 'APPROXIMATE': map.setZoom(13); break;
                                        }
                                    }else{
                                        if (results[1]) {
                                            document.getElementById(input).value = results[1].formatted_address;
                                        } else {
                                            console.log('No results found');
                                        }
                                    }
                                
                                } else {
                                    console.log('Geocode was not successful for the following reason: ' + status);
                                }
                            });
                        }

                        function CenterControl(controlDiv, map) {
                            // Set CSS for the control border.
                            var controlUI = document.createElement('div');
                            controlUI.style.backgroundColor = '#fff';
                            controlUI.style.border = '2px solid #fff';
                            controlUI.style.borderRadius = '3px';
                            controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
                            controlUI.style.cursor = 'pointer';
                            controlUI.style.marginBottom = '2px';
                            controlUI.style.marginLeft = '10px';
                            controlUI.style.textAlign = 'center';
                            controlUI.title = 'Click to locate you.';
                            controlDiv.appendChild(controlUI);

                            // Set CSS for the control interior.
                            var controlText = document.createElement('div');
                            controlText.style.color = 'rgb(25,25,25)';
                            controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
                            controlText.style.fontSize = '16px';
                            controlText.style.lineHeight = '15px';
                            controlText.innerHTML = '<i class="mdi-maps-my-location grey-text text-darken-1" style="font-size:20px; padding:3px;"></i>';
                            controlUI.appendChild(controlText);

                            // Setup the click event listeners: simply set the map to Chicago.
                            controlUI.addEventListener('click', function() {
                                $('#main-preloader').show();
                                if (navigator.geolocation) {
                                    navigator.geolocation.getCurrentPosition(mapGoPosition);
                                } else {
                                    Materialize.toast('<span class="toast-warning">Oops! This navigator has no support for locating you.</span>',4500);
                                    $('#main-preloader').hide();
                                }
                            });
                        }

                        function mapGoPosition(position) {
                            map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
                            map.setZoom(16);
                            $('#main-preloader').hide();
                        }

                        function getUrlVars(){
                            var vars = [], hash;
                            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                            for(var i = 0; i < hashes.length; i++)
                            {
                                hash = hashes[i].split('=');
                                vars.push(hash[0]);
                                vars[hash[0]] = hash[1];
                                if (vars[hash[0]]) if (vars[hash[0]].search(/#/) != -1) vars[hash[0]]=vars[hash[0]].substr(0,vars[hash[0]].search(/#/));
                            }
                            return vars;
                        }
                            
                        function addCommas(val) {
                            while (/(\d+)(\d{3})/.test(val.toString())) {
                                var val = val.toString().replace(/(\d+)(\d{3})/, '$1' + ',' + '$2');
                            }
                            return val;
                        }   
                            
                        function createTileStyle(tStyle, table) {
                            var mOverlap;
                            var close;
                            var tileStyle = "#" + table + "{";
                            switch (tStyle) {
                                case 'normal':
                                    mOverlap = true;
                                    closeStyle = "}";
                                    break;
                                case 'cluster':
                                    mOverlap = false;
                                    closeStyle = "}";
                                    break;
                                case 'heat':
                                    return "#" + table + "{marker-fill:{{brand_secondary_color}};marker-width:10;marker-line-color:#FFF;marker-line-width:1;marker-line-opacity:1;marker-fill-opacity:0.9;marker-comp-op:multiply;marker-type:ellipse;marker-placement:point;marker-allow-overlap:true;marker-clip:false;marker-multi-policy:largest;}";
                                case 'intensity':
                                    return "#" + table + "{first/marker-fill:#005761;first/marker-opacity:0.01;first/marker-width:80;first/marker-line-width:0;first/marker-placement:point;first/marker-allow-overlap:true;first/marker-comp-op:lighten;second/marker-fill:#005761;second/marker-opacity:0.02;second/marker-width:50;second/marker-line-width:0;second/marker-placement:point;second/marker-allow-overlap:true;second/marker-comp-op:lighten;third/marker-fill:#005761;third/marker-opacity:0.15;third/marker-width:20;third/marker-line-width:0;third/marker-placement:point;third/marker-allow-overlap:true;third/marker-comp-op:lighten;}";                         
                                case 'bubble':
                                    mOverlap = false;
                                    closeStyle = "}#" + table + "{marker-fill:#FF5C00;marker-line-color:#FFF;marker-line-width:2;marker-line-opacity:1;marker-opacity:0.9;marker-placement:point;marker-type:ellipse;marker-allow-overlap:true;marker-clip:false;marker-multi-policy:largest;}"
                                    break;
                                default:
                                    mOverlap = true;
                                    closeStyle = "}";
                                    break;
                            }
                            
                            tileStyle += "marker-file: url(http://com.cartodb.users-assets.production.s3.amazonaws.com/maki-icons/marker-18.svg);marker-fill-opacity: 1.0;marker-line-color: {{brand_secondary_color}};marker-line-width: 2;marker-line-opacity: 1;marker-placement: point;marker-type: ellipse;marker-width: 30;marker-fill: {{brand_tertiary_color}};marker-allow-overlap:" + mOverlap +";";
                        
                            for (var x in reportDict){
                                if  (city_catMarkers.length < 30){
                                    for (var y in reportDict[x].icon_url){
                                        tileStyle += '[sub_category="'+y+'"] {marker-file: url('+ reportDict[x].icon_url[y] +');marker-fill: #'+reportDict[x].color+';marker-width: 30;}';    
                                    }
                                }else if (Object.keys(reportDict).length < 30){
                                    tileStyle += '[group_category="'+x+'"] {marker-file: url('+ reportDict[x].icon +');marker-fill: #'+reportDict[x].color+';marker-width: 30;}';    
                                }else{
                                    tileStyle += '[group_category="'+x+'"] {marker-fill: #'+reportDict[x].color+';}';    
                                }   
                            }
                            
                            tileStyle += closeStyle;
                            
                            if (tStyle == "bubble") {
                                for (var j = upperVotes.length - 1; j >= 0; j--) {
                                    tileStyle += "#" + table + "[votes<=" + upperVotes[j] + "]{marker-width:" + widthMarkers[j] + ";marker-line-color:yellow;marker-line-width:10;}";
                                }
                            }
                            return tileStyle;
                        }

                        function setMapView(mapstyle){
                            sublayers[1].setCartoCSS(createTileStyle(mapstyle, city_table_name));
                        }

                        function populateModal(data, latlng){
                            map.setCenter(new google.maps.LatLng(latlng[0], latlng[1]));
                            if (data.image_url != 'None'){
                                $('#report_image').attr("src", data.image_url );
                                $('#report_image').show();
                                $('#gSV').addClass('m6');                           
                            }else{ 
                                $('#report_image').hide();
                                $('#gSV').removeClass('m6');                            
                            }
                            $('#report_ticket').val(data.cartodb_id);
                            $('#report_follows').val(data.follows);
                            $('#commentbox').val('');
                            $('#report_cartodb_id').html(data.cartodb_id);
                            $('#report_followers').html(data.follows);
                            $('#report_group_category').html(data.group_category);
                            $('#report_sub_category').html(data.sub_category);
                            $('#report_description').html(data.description);
                            $('#report_address').html(data.address_from);
                            var qry = "SELECT _when FROM " + city_table_name + " WHERE cartodb_id = " + data.cartodb_id;
                            city_sql.execute(qry).done(function(data) {
                                $('#report_date').html(data.rows[0]._when.substr(0,10));
                            });
                            $('#report_status').html(getStatus(data.status));
                            $('#report_via').html(getVia(data.via));
                            $('#followBtn').html('Seguir');

                            $('#modal3').openModal();
                            loadComments($('#report_ticket').val());
                            getgSV(latlng)

                            if (document.getElementById('close-city')) document.getElementById('close-city').click();
                        }

                        function getStatus(st){
                            switch(st){
                                case 'open':
                                    return 'Abierto';   
                                case 'halted':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #ffc107";
                                    return 'En espera <i class="mdi-action-assignment amber-text"></i>';
                                case 'assigned':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #ffc107";
                                    return 'Asignado <i class="mdi-action-assignment-ind amber-text"></i>';
                                case 'spam':
                                    return 'Spam';
                                case 'archived':
                                    return 'Archivado';
                                case 'forgot':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #F44336";
                                    return 'Olvidado <i class="mdi-action-assignment-returned red-text"></i>';
                                case 'rejected':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #F44336";
                                    return 'Rechazado <i class="mdi-action-assignment-return red-text"></i>';
                                case 'working':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #ffc107";
                                    return 'En proceso <i class="mdi-action-assignment amber-text"></i>';
                                case 'answered':
                                    return 'Respondido';
                                case 'solved':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #4CAF50";
                                    return 'Resuelto <i class="mdi-action-assignment-turned-in green-text"></i>';
                                case 'failed':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #F44336";
                                    return 'Fallo <i class="mdi-action-assignment-late red-text"></i>';
                            }
                        }

                        function getVia(via){
                            switch(via){
                                case 'web':
                                    return 'Web'
                                case 'whatsapp':
                                    return 'Whatsapp'
                                case 'phone':
                                    return 'Teléfono'
                                case 'street':
                                    return 'Alcalde en tu calle'
                                case 'networks':
                                    return 'Redes sociales'
                                case 'office':
                                    return 'Oficina'
                                case 'event':
                                    return 'Evento'
                                case 'letter':
                                    return 'Oficio'
                                case 'media':
                                    return 'Medios'
                            }
                        }

                        function loadComments(_id){
                            var url = "/report/comments/ticket/"+_id+"/";
                             $.ajax({
                                 url: url,
                                 type: 'GET',
                                 success: function(data) { 
                                     console.log(data)
                                 }
                             }).done(function(data) {
                                 $('#report_comments').html(data.logs.html);
                             });
                        }

                        {% if user_id %}

                            document.querySelector('#submit_report_form_comment').addEventListener('click', function() { 
                                if (document.getElementById("commentbox").value == '')
                                    Materialize.toast('<span class="toast-warning">Oops! Por favor escribe tu comentario primero.</span>',4500);
                                else{
                                    var url = "{{ uri_for('materialize-report-comments-add') }}?ticket="+$('#report_ticket').val()+"&comment=" + document.getElementById("commentbox").value;
                                     $.ajax({
                                         url: url,
                                         type: 'GET',
                                         success: function(data) { 
                                             console.log(data)
                                         }
                                     }).done(function(data) {
                                         if (data.status == 'success'){
                                            loadComments($('#report_ticket').val());
                                            $('#commentbox').val('');
                                            Materialize.toast('<span class="toast-success">Gracias por tus comentarios.</span>',4500);
                                         }else{
                                            Materialize.toast('<span class="toast-warning">Algo ha sucedido, por favor intenta de nuevo.</span>',4500);
                                         }
                                     });
                                }                               
                            });
                        {% endif %}

                        function getgSV(location) {
                            var loc = new google.maps.LatLng(location[0], location[1]);
                            var _gsv = false;
                            sv.getPanoramaByLocation(loc, 50, function(data, status) {
                                if (status == google.maps.StreetViewStatus.OK) {
                                    $('#gSV').show();
                                    panorama = new google.maps.StreetViewPanorama(
                                        document.getElementById('gSVpanorama'), {
                                            position: loc,
                                            addressControlOptions: {
                                              position: google.maps.ControlPosition.BOTTOM_CENTER
                                            },
                                            linksControl: false,
                                            panControl: false,
                                            enableCloseButton: true,
                                            scrollwheel: false,
                                            zoomControl: false,
                                            fullScreenControl: false
                                        }
                                    );
                                    _gsv = true;
                                }else{
                                    $('#gSV').hide();
                                    _gsv = false;
                                }
                            });
                            return _gsv;
                        }

                        function followReport(elem){
                            var kind;
                            if (elem.innerHTML.indexOf('Seguir') >= 0){
                                kind = 'follow';
                            }
                            else if (elem.innerHTML.indexOf('Dejar de seguir') >= 0){
                                kind = 'unfollow';
                            }
                            else{
                                kind = 'none';
                            }

                            $.ajax({
                                url: "{{ uri_for('materialize-report-follow') }}",
                                type: 'POST',
                                data: { 
                                    'report_id': $('#report_ticket').val(),
                                    'user_id': {{user_id}},
                                    '_csrf_token': '{{ csrf_token() }}',
                                    'kind': kind
                                }
                            }).done(function(data) {
                                console.log(data);
                                if (kind == 'follow' && data.status == 'success' && data.contents != 'user is creator'){
                                    elem.innerHTML = elem.innerHTML.replace('Seguir','Dejar de seguir');
                                }
                                if (kind == 'unfollow' && data.status == 'success' && data.contents != 'user is creator'){
                                    elem.innerHTML = elem.innerHTML.replace('Dejar de seguir', 'Seguir');
                                }
                                var qry = "SELECT follows FROM " + city_table_name + " WHERE cartodb_id = " + $('#report_ticket').val();
                                city_sql.execute(qry).done(function(data) {
                                    $('#report_followers').html(data.rows[0].follows);
                                    $('#report_follows').val(data.rows[0].follows)
                                });
                                if (data.contents == 'user already following')
                                    Materialize.toast('<span class="toast-warning">Oops! Ya sigues este reporte.</span>',4500);
                                else if (data.contents == 'follow request successful')
                                    Materialize.toast('<span class="toast-success">Bravo! Ahora podrás verlo en tus reportes.</span>',4500);
                                else if (data.contents == 'unfollow request successful')
                                    Materialize.toast('<span class="toast-success">Has dejado de seguir este reporte.</span>',4500);
                                else if (data.contents == 'user is creator')
                                    Materialize.toast('<span class="toast-success">Tú creaste este reporte, ya se encuentra en tus reportes.</span>',4500);
                            });
                        }

                        {% if has_address %}
                            function myZone(){
                                if (zoned){
                                    zoned = false;    
                                    $('#my-zone').html('<i class="mdi-navigation-fullscreen"></i> Ver mi colonia');
                                    $('#my-zone-m').html('<i class="mdi-navigation-fullscreen"></i> Ver mi colonia');
                                }                       
                                else{
                                    zoned = true;    
                                    $('#my-zone').html('<i class="mdi-navigation-fullscreen"></i> Reestablecer mapa');
                                    $('#my-zone-m').html('<i class="mdi-navigation-fullscreen"></i> Reestablecer mapa');
                                }

                                Q();
                            }
                        {% endif %}
                        
                        function updateCounters(q){
                            var nq = q.replace('SELECT *', 'SELECT count(*)');
                            city_sql.execute(nq).done(function(data) {
                                
                                var add = 0;
                                $('#c_alcalde').html(data.rows[0].count);
                                $('#c_alcalde_M').html(data.rows[0].count);
                                
                                add += document.getElementById('check_alcalde').checked ? data.rows[0].count : 0;
                                
                                $('#rep_count').html(addCommas(add));
                                $('#rep_count_M').html(addCommas(add));
                            })                     
                        }
                                            
                        function Q(){
                            var cCss;
                            var auxWhere = true;
                            var q = "SELECT * FROM " + city_table_name + "  WHERE status not in ('spam', 'archived', 'forgot') AND pvt = false";
                            //Zone
                            if (zoned){
                                var coof = "{{address_from_coord}}";
                                var m1 = coof.split(',').map(Number);           
                                q+= " AND ( ST_Intersects("+city_table_name+".the_geom,ST_Buffer( ST_SetSRID('POINT("+m1[1]+" "+m1[0]+")'::geometry , 4326),0.007194572847353697)))";   
                            }

                            //Dates
                            if (document.getElementById('calendar').checked){
                                var from = document.getElementById('from').value;
                                var until = document.getElementById('until').value;
                                if (from && until){
                                    if (auxWhere) {
                                        q += " AND ";
                                    } else {
                                        q += " WHERE ";                        
                                    }
                                    q += "_when BETWEEN SYMMETRIC ('"+from+"') AND ('"+until+"')";
                                    auxWhere = true;
                                }
                            }
                            
                            //Categories
                            var groupList = document.getElementsByClassName("filterGroup");
                            var t, groupGrp=[];                        
                            for (var i = 0, j = groupList.length;i<j;i++){
                                if(groupList[i].checked){
                                    if (auxWhere) {
                                        t = " AND ";
                                    } else {
                                        t = " WHERE ";                        
                                    }                        
                                    groupGrp.push("'" + groupList[i].id  + "'");
                                }
                            }
                            if (groupGrp.length>0) {
                                t += "group_category IN (" + groupGrp.join() + ")";
                                auxWhere = true;
                                q += t;
                            }

                            //Subcategories
                            var categoryList = document.getElementsByClassName("filterCategory");
                            var t, categoryGrp=[];                        
                            for (var i = 0, j = categoryList.length;i<j;i++){
                                if(categoryList[i].checked){
                                    if (auxWhere) {
                                        t = " AND ";
                                    } else {
                                        t = " WHERE ";                        
                                    }                        
                                    categoryGrp.push("'" + categoryList[i].id  + "'");
                                }
                            }
                            if (categoryGrp.length>0) {
                                t += "sub_category IN (" + categoryGrp.join() + ")";
                                auxWhere = true;
                                q += t;
                            }
                            
                            //Status
                            var statusList = document.getElementsByClassName("filterStatus");
                            var t, statusGrp=[];                        
                            for (var i = 0, j = statusList.length;i<j;i++){
                                if(statusList[i].checked){
                                    if (auxWhere) {
                                        t = " AND ";
                                    } else {
                                        t = " WHERE ";                        
                                    }                        
                                    statusGrp.push("'" + statusList[i].id  + "'");
                                }
                            }
                            if (statusGrp.length>0) {
                                t += "status IN (" + statusGrp.join() + ")";
                                auxWhere = true;
                                q += t;
                            }
                            query = q;    
                            updateCounters(q);
                            console.log(q);
                            if (sublayers[1]) sublayers[1].setSQL(q);
                        }   
                    </script>
                    <script type="infowindow/html" id="infowindow_{{cartodb_reports_table}}">
                        {% raw %}
                        <div class="cartodb-popup v2" style="display:none;"> 
                            <a id="close-city" href="#close" class="cartodb-popup-close-button close">x</a> 
                            <div class="cartodb-popup-header"> 
                                <p style="color:#DDDDDD; padding-left:10px; margin-bottom:-20px">Grupo</p> 
                                <h3 style="padding:10px;" class="brand-secondary-color-text">{{group_category}}</h3> 
                                <span class="separator"></span> 
                            </div> 
                            <div class="cartodb-popup-content-wrapper"> 
                                <div class="cartodb-popup-content">                            
                                    <p style="color:#DDDDDD; padding-left:10px; margin-bottom:-10px">Categoría</p> 
                                    <h4 style="padding:10px;" class="brand-secondary-color-text">{{sub_category}}</h4> 
                                </div> 
                            </div> 
                            <div class="cartodb-popup-tip-container"> </div> 
                        </div> 
                        {% endraw %}  
                    </script>
                {% else %}
                    <script type="text/javascript">
                        // cartodb
                        var cic_user = '{{cartodb_cic_user}}';
                        var cic_table_name = '{{cartodb_cic_reports_table}}';
                        var cic_mun_table_name = '{{cartodb_polygon_table}}';
                        var cic_polygon_name = '{{cartodb_polygon_name}}'
                        var cic_sql = new cartodb.SQL({ user: '{{cartodb_cic_user}}' });
                        var city_user = '{{cartodb_user}}';
                        var city_table_name = '{{cartodb_reports_table}}';
                        var city_mun_table_name = '{{cartodb_polygon_table}}';
                        var city_polygon_name = '{{cartodb_polygon_name}}'
                        var city_sql = new cartodb.SQL({ user: '{{cartodb_user}}' });
                        var sublayers = [];
                        var zoned = false;
                        var sourceurl = "{{cartodb_markers_url}}";
                        var city_catMarkers = [];
                        var reportDict;
                        var catMarkers = [
                            ['MTYMUYBIEN', 'purple.png'],
                            ['AVISOS', 'green.png'],
                            ['EVENTO PUBLICO', 'green.png'],
                            ['OBSERVADOR CIUDADANO', 'green.png'],
                            ['ALCANTARILLAS', 'amber.png'],
                            ['ALUMBRADO PUBLICO', 'amber.png'],
                            ['FALTA ELECTRICIDAD', 'amber.png'],
                            ['FUGA', 'cyan.png'],
                            ['PARQUES DESCUIDADOS', 'amber.png'],
                            ['RECOLECCION DE BASURA', 'amber.png'],
                            ['ACCIDENTE', 'orange.png'],
                            ['BACHE O VIA DAÑADA', 'purple.png'],
                            ['OBRAS Y/O VIA CERRADA', 'purple.png'],
                            ['SEMAFORO DESCOMPUESTO', 'purple.png'],
                            ['VIALIDAD', 'teal.png'],
                            ['PROPUESTA COMUNIDAD', 'green.png'],
                            ['PROPUESTA SEGURIDAD', 'green.png'],
                            ['PROPUESTA SERV PUBLICOS', 'green.png'],
                            ['PROPUESTA VIALIDAD', 'green.png'],
                            ['EMERGENCIAS', 'red.png'],
                            ['INCENDIO', 'blue.png'],
                            ['ROBO', 'blue.png'],
                            ['SITUACION DE RIESGO', 'blue.png'],
                            ['DETENCION DE BANDAS', 'blue.png'],
                            ['EXTORSION', 'blue.png'],
                            ['HOMICIDIO', 'blue.png'],
                            ['SECUESTRO', 'blue.png'],
                            ['SOSPECHOSO', 'blue.png'],
                            ['AUTO ABANDONADO', 'blue.png'],
                            ['PERCEPCION DE INSEGURIDAD', 'blue.png'],
                            ['OTROS', 'grey.png'],
                            ['ROBO AUTO', 'blue.png']];

                        function allTrue(arr) {
                          for(var i = 0, j = arr.length; i<j; i++)
                              if(!arr[i]) return false;
                          return true;
                        }
                        
                        function singleCheck(arr) {
                          var cont = 0;
                          for(var i = 0, j = arr.length; i<j; i++){
                             if(arr[i].checked) cont++;
                             if (cont > 1) return 0; 
                          }
                          return cont;
                        }
                        
                        function catFilter(dict){
                            var container = document.getElementById("categoryfilterContainer");
                            var html='';
                            for (var x in dict){
                                if (!allTrue(dict[x].pf)){
                                    html += '<div class="row"><div class="col s12"><div class="card-panel"><span class="card-title"><input class="filterControl filterGroup" type="checkbox" id="'+x+'"><label for="'+x+'"><span style="font-size: 30px;">'+x+'</span></label></span><div class="row">';
                                    for (var i = 0, j = dict[x].categories.length; i<j; i++){
                                        if (!dict[x].pf[i]){
                                            html += '<p class="col s12 m4"><input class="filterControl filterCategory" type="checkbox" id="'+dict[x]['categories'][i]+'"><label for="'+dict[x]['categories'][i]+'">'+dict[x]['categories'][i]+'</label></p>';
                                        }
                                    }
                                    html += '</div></div></div></div>';
                                }
                            }     
                            container.innerHTML = html;
                            $('#categoryfilterbtn').attr('disabled',false);
                            $('.filterControl').change(function() { Q(); });

                        }
                        
                        /* MAPS RELATED */
                        var panorama, sv = new google.maps.StreetViewService();
                        var mapCenter = [{{lat}},{{lng}}] , map;
                        google.maps.event.addDomListener(window,'load', init);
                        var query;                    
                        
                        
                        function init(){
                            var mapOptions = {
                                center: new google.maps.LatLng(mapCenter[0], mapCenter[1]),
                                zoom: {% if is_mobile %}11{% else %}12{% endif %},
                                minZoom:5,
                                zoomControl: true,
                                zoomControlOptions: {
                                    style: google.maps.ZoomControlStyle.SMALL,  
                                    position: google.maps.ControlPosition.LEFT_BOTTOM   
                                },
                                mapTypeControl: false,
                                scrollwheel: false,
                                streetViewControl: true,
                                streetViewControlOptions: {
                                    position: google.maps.ControlPosition.LEFT_BOTTOM   
                                },
                                panControl:false,
                                backgroundColor: 'rgb(249, 249, 249)',
                                rotateControl:true,
                                overviewMapControl:true
                            };
                            map = new google.maps.Map(document.getElementById('map'), mapOptions);
                            
                            google.maps.event.addDomListener(window, 'resize', function() {
                                map.setCenter({lat: mapCenter[0], lng: mapCenter[1]});
                            });

                            var autocomplete_from = new google.maps.places.Autocomplete(document.getElementById('search_address'))
                            autocomplete_from.bindTo('bounds', map);
                            google.maps.event.addListener(autocomplete_from, 'place_changed', function() {
                                var place = autocomplete_from.getPlace();
                                if (place.geometry.viewport) {
                                  map.fitBounds(place.geometry.viewport);
                                }else{
                                  map.setCenter(place.geometry.location);
                                  map.setZoom(17);
                                }
                            }); 

                            var centerControlDiv = document.createElement('div');
                            var centerControl = new CenterControl(centerControlDiv, map);
                            centerControlDiv.index = 1;
                            map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(centerControlDiv);
                            
                            // CIC LAYERS
                            var cic_query= "SELECT " + cic_table_name + ".the_geom, " + cic_table_name + ".the_geom_webmercator, " + cic_table_name + ".post_cat, " + cic_table_name + ".post_title, " + cic_table_name + ".channel, to_char(" + cic_table_name + ".last_mod,'DD/MM/YYYY') as last_mod FROM " + cic_table_name + ", " + cic_mun_table_name + " WHERE ST_Intersects(" + cic_table_name + ".the_geom, " + cic_mun_table_name + ".the_geom) AND " + cic_mun_table_name + ".name IN ('" + cic_polygon_name + "') AND ("+ cic_table_name + ".created_at BETWEEN ('2015-11-01') AND now())";      
                            var interactivity_ = ["post_cat","post_title","channel","last_mod"];
                            var layerSource = {
                                user_name: cic_user,
                                type: 'cartodb',
                                sublayers: [{
                                    sql: "SELECT " + cic_mun_table_name + ".* FROM " + cic_mun_table_name + " WHERE " + cic_mun_table_name + ".name IN ('" + cic_polygon_name + "')",
                                    cartocss: "#" + cic_mun_table_name + "{line-color: #EB332C;line-width: 2;line-opacity: 1;}"

                                },{
                                    sql: cic_query,
                                    cartocss: createTileStyle('normal', cic_table_name),
                                    interactivity: interactivity_

                                }]
                            };                        
                            cartodb.createLayer(map,layerSource)
                            .on('done', function(layer) {
                                map.overlayMapTypes.setAt(0, layer);
                                for (var i = 0; i < layer.getSubLayerCount(); i++) {
                                   sublayers[i] = layer.getSubLayer(i);
                                   console.log("Congrats, you added sublayer #" + i + "!");
                                }
                                
                                // NO INTERACTION FOR SUBLAYER 0: GUADALUPE POLYGON 

                                sublayers[1].infowindow.set('template', $('#infowindow_'+cic_table_name).html());
                                cdb.vis.Vis.addInfowindow(map, sublayers[1], interactivity_, {
                                    infowindowTemplate: $('#infowindow_'+cic_table_name).html()
                                });
                                sublayers[1].setInteraction(true);                                 
                                sublayers[1].on('featureClick', function(e, latlng, pos, data) {
                                      //populateModalCIC(data);
                                });  
                            });    

                            // GPE LAYERS
                            var city_query= "SELECT * FROM " + city_table_name + "  WHERE status not in ('spam', 'archived', 'forgot') AND pvt = false";        
                            var city_interactivity = ["cartodb_id", "group_category", "sub_category", "via", "description", "_when", "address_from", "folio", "follows", "rating", "status", "image_url", "via", "title"];
                            $.ajax({
                                url: "{{ uri_for('materialize-report-categories') }}",
                                type: 'GET'
                            }).done(function(data) {
                                reportDict = data;
                                catFilter(reportDict);
                                for (var x in reportDict){
                                    for (var y in reportDict[x].icon_url){
                                        city_catMarkers.push([y, reportDict[x].icon_url[y], reportDict[x].color]);
                                    }
                                }
                                layerSource = {
                                    user_name: city_user,
                                    type: 'cartodb',
                                    sublayers: [{
                                        sql: city_query,
                                        cartocss: createTileStyle('normal',city_table_name),
                                        interactivity: city_interactivity
                                    }]
                                };
                                cartodb.createLayer(map,layerSource)
                                .on('done', function(layer) {
                                    map.overlayMapTypes.setAt(1, layer);
                                    for (var i = 0, j=2; i < layer.getSubLayerCount(); i++,j++) {
                                       sublayers[j] = layer.getSubLayer(i);
                                       console.log("Congrats, you added sublayer #" + j + "!");
                                    }
                                    sublayers[1].hide();
                                    sublayers[2].infowindow.set('template', $('#infowindow_'+city_table_name).html());
                                    cdb.vis.Vis.addInfowindow(map, sublayers[2], city_interactivity, {
                                        infowindowTemplate: $('#infowindow_'+city_table_name).html()
                                    });
                                    sublayers[2].setInteraction(true);                                 
                                    sublayers[2].on('featureClick', function(e, latlng, pos, data) {
                                          populateModal(data, latlng);
                                    });  
                                    
                                    cic_sql.execute(cic_query).done(function(data) {
                                        var cic_total = data.total_rows;
                                        city_sql.execute(city_query).done(function(data) {
                                            $('#rep_count').html(addCommas(data.total_rows));
                                            $('#rep_count_M').html(addCommas(data.total_rows));
                                            $('#c_alcalde').html(data.total_rows);
                                            $('#c_alcalde_M').html(data.total_rows);
                                            $('#c_cic').html(cic_total);
                                            $('#c_cic_M').html(cic_total);
                                        }) 
                                    }) 

                                    var obj = getUrlVars();
                                    if (obj.cdb_id){
                                        var query = "select st_y(the_geom) as lat, st_x(the_geom) as lon, cartodb_id, _when, address_from, description, folio, follows, group_category, image_url, rating, status, sub_category, title, via from "+city_table_name+" where cartodb_id = " + obj.cdb_id;
                                        city_sql.execute(query).done(function(data) {
                                            if(data.total_rows >= 1) {
                                                 populateModal(data.rows[0], [data.rows[0].lat, data.rows[0].lon]);
                                                 map.setZoom(21);
                                            }
                                        })
                                    }
                                }); 
                            });
                            
                            //FILTER RELATED LISTENERS
                            $('#calendar').change( function() {
                                $('#from').attr('disabled',!this.checked);
                                $('#until').attr('disabled',!this.checked);
                            });
                                                                        
                            $('.filterbtn').on('click', function() {
                                $('#modal'+this.id).openModal();
                            });
        
                            $('.layerControl').change(function() {
                                var add=0;
                                if (this.id == 'check_cic') {
                                    if (this.checked) sublayers[1].show();
                                    else sublayers[1].hide();
                                }
                                if (this.id == 'check_alcalde'){
                                    if (this.checked) sublayers[2].show();
                                    else sublayers[2].hide();
                                }
                                
                                add += document.getElementById('check_alcalde').checked ? Number($('#c_alcalde').html()) : 0;
                                add += document.getElementById('check_cic').checked ? Number($('#c_cic').html()) : 0;

                                $('#rep_count').html(addCommas(add));
                                $('#rep_count_M').html(addCommas(add));                        
                            });
                            
                            $('#removeFilter').on('click', function() {
                                $('.filterControl').prop('checked',false);
                                Q();
                            });
                            setTimeout(function(){
                              $('#right-sidebar-nav').hide();
                            }, 10000);
                        }

                        function codeAddress(input) {
                            var address, obj;                               

                            address = document.getElementById(input).value;
                            obj = { 'address': address };
                            geocoder.geocode( obj, function(results, status) {
                                if (status == google.maps.GeocoderStatus.OK) {
                                    
                                    if (typeof(input) === 'string') {
                                        map.setCenter(results[0].geometry.location);
                                        switch (results[0].geometry.location_type){
                                            case 'ROOFTOP': map.setZoom(17); break;
                                            case 'RANGE_INTERPOLATED': map.setZoom(16); break;
                                            case 'GEOMETRIC_CENTER': map.setZoom(15); break;
                                            case 'APPROXIMATE': map.setZoom(13); break;
                                        }
                                    }else{
                                        if (results[1]) {
                                            document.getElementById(input).value = results[1].formatted_address;
                                        } else {
                                            console.log('No results found');
                                        }
                                    }
                                
                                } else {
                                    console.log('Geocode was not successful for the following reason: ' + status);
                                }
                            });
                        }

                        function CenterControl(controlDiv, map) {
                            // Set CSS for the control border.
                            var controlUI = document.createElement('div');
                            controlUI.style.backgroundColor = '#fff';
                            controlUI.style.border = '2px solid #fff';
                            controlUI.style.borderRadius = '3px';
                            controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
                            controlUI.style.cursor = 'pointer';
                            controlUI.style.marginBottom = '2px';
                            controlUI.style.marginLeft = '10px';
                            controlUI.style.textAlign = 'center';
                            controlUI.title = 'Click to locate you.';
                            controlDiv.appendChild(controlUI);

                            // Set CSS for the control interior.
                            var controlText = document.createElement('div');
                            controlText.style.color = 'rgb(25,25,25)';
                            controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
                            controlText.style.fontSize = '16px';
                            controlText.style.lineHeight = '15px';
                            controlText.innerHTML = '<i class="mdi-maps-my-location grey-text text-darken-1" style="font-size:20px; padding:3px;"></i>';
                            controlUI.appendChild(controlText);

                            // Setup the click event listeners: simply set the map to Chicago.
                            controlUI.addEventListener('click', function() {
                                $('#main-preloader').show();
                                if (navigator.geolocation) {
                                    navigator.geolocation.getCurrentPosition(mapGoPosition);
                                } else {
                                    Materialize.toast('<span class="toast-warning">Oops! This navigator has no support for locating you.</span>',4500);
                                    $('#main-preloader').hide();
                                }
                            });
                        }

                        function mapGoPosition(position) {
                            map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
                            map.setZoom(16);
                            $('#main-preloader').hide();
                        }

                        function getUrlVars(){
                            var vars = [], hash;
                            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                            for(var i = 0; i < hashes.length; i++)
                            {
                                hash = hashes[i].split('=');
                                vars.push(hash[0]);
                                vars[hash[0]] = hash[1];
                                if (vars[hash[0]]) if (vars[hash[0]].search(/#/) != -1) vars[hash[0]]=vars[hash[0]].substr(0,vars[hash[0]].search(/#/));
                            }
                            return vars;
                        }
                            
                        function addCommas(val) {
                            while (/(\d+)(\d{3})/.test(val.toString())) {
                                var val = val.toString().replace(/(\d+)(\d{3})/, '$1' + ',' + '$2');
                            }
                            return val;
                        }   
                            
                        function createTileStyle(tStyle, table) {
                            var mOverlap;
                            var close;
                            var tileStyle = "#" + table + "{";
                            switch (tStyle) {
                            case 'normal':
                                mOverlap = true;
                                closeStyle = "}";
                                break;
                            case 'cluster':
                                mOverlap = false;
                                closeStyle = "}";
                                break;
                            case 'heat':
                                return "#" + table + "{marker-fill:{{brand_secondary_color}};marker-width:10;marker-line-color:#FFF;marker-line-width:1;marker-line-opacity:1;marker-fill-opacity:0.9;marker-comp-op:multiply;marker-type:ellipse;marker-placement:point;marker-allow-overlap:true;marker-clip:false;marker-multi-policy:largest;}";
                            case 'intensity':
                                return "#" + table + "{first/marker-fill:#005761;first/marker-opacity:0.01;first/marker-width:80;first/marker-line-width:0;first/marker-placement:point;first/marker-allow-overlap:true;first/marker-comp-op:lighten;second/marker-fill:#005761;second/marker-opacity:0.02;second/marker-width:50;second/marker-line-width:0;second/marker-placement:point;second/marker-allow-overlap:true;second/marker-comp-op:lighten;third/marker-fill:#005761;third/marker-opacity:0.15;third/marker-width:20;third/marker-line-width:0;third/marker-placement:point;third/marker-allow-overlap:true;third/marker-comp-op:lighten;}";                         
                            case 'bubble':
                                mOverlap = false;
                                closeStyle = "}#" + table + "{marker-fill:#FF5C00;marker-line-color:#FFF;marker-line-width:2;marker-line-opacity:1;marker-opacity:0.9;marker-placement:point;marker-type:ellipse;marker-allow-overlap:true;marker-clip:false;marker-multi-policy:largest;}"
                                break;
                            default:
                                mOverlap = true;
                                closeStyle = "}";
                                break;
                            }
                            
                            if (table == cic_table_name){
                                for (var i = 0; i < catMarkers.length; i++) {
                                    tileStyle += "[post_cat='" + catMarkers[i][0] + "']{marker-file:url('" + sourceurl  + catMarkers[i][1] + "');marker-clip:true;marker-allow-overlap:" + mOverlap + ";marker-width:50;}";
                                }
                            }else{
                                tileStyle += "marker-file: url(http://com.cartodb.users-assets.production.s3.amazonaws.com/maki-icons/marker-18.svg);marker-fill-opacity: 1.0;marker-line-color: {{brand_secondary_color}};marker-line-width: 2;marker-line-opacity: 1;marker-placement: point;marker-type: ellipse;marker-width: 30;marker-fill: {{brand_tertiary_color}};marker-allow-overlap:" + mOverlap +";";
                            
                                for (var x in reportDict){
                                    if  (city_catMarkers.length < 30){
                                        for (var y in reportDict[x].icon_url){
                                            tileStyle += '[sub_category="'+y+'"] {marker-file: url('+ reportDict[x].icon_url[y] +');marker-fill: #'+reportDict[x].color+';marker-width: 30;}';    
                                        }
                                    }else if (Object.keys(reportDict).length < 30){
                                        tileStyle += '[group_category="'+x+'"] {marker-file: url('+ reportDict[x].icon +');marker-fill: #'+reportDict[x].color+';marker-width: 30;}';    
                                    }else{
                                        tileStyle += '[group_category="'+x+'"] {marker-fill: #'+reportDict[x].color+';}';    
                                    }   
                                }
                            
                            }
                            
                            tileStyle += closeStyle;
                            
                            if (tStyle == "bubble") {
                                for (var j = upperVotes.length - 1; j >= 0; j--) {
                                    tileStyle += "#" + table + "[votes<=" + upperVotes[j] + "]{marker-width:" + widthMarkers[j] + ";marker-line-color:yellow;marker-line-width:10;}";
                                }
                            }
                            //console.log(tileStyle);
                            return tileStyle;
                        }

                        function setMapView(mapstyle){
                            sublayers[1].setCartoCSS(createTileStyle(mapstyle, cic_table_name));
                            sublayers[2].setCartoCSS(createTileStyle(mapstyle, city_table_name));
                        }

                        function populateModal(data, latlng){
                            map.setCenter(new google.maps.LatLng(latlng[0], latlng[1]));
                            if (data.image_url != 'None'){
                                $('#report_image').attr("src", data.image_url );
                                $('#report_image').show();
                                $('#gSV').addClass('m6');                           
                            }else{ 
                                $('#report_image').hide();
                                $('#gSV').removeClass('m6');                            
                            }
                            $('#report_ticket').val(data.cartodb_id);
                            $('#report_follows').val(data.follows);
                            $('#commentbox').val('');
                            $('#report_cartodb_id').html(data.cartodb_id);
                            $('#report_followers').html(data.follows);
                            $('#report_group_category').html(data.group_category);
                            $('#report_sub_category').html(data.sub_category);
                            $('#report_description').html(data.description);
                            $('#report_address').html(data.address_from);
                            var qry = "SELECT _when FROM " + city_table_name + " WHERE cartodb_id = " + data.cartodb_id;
                            city_sql.execute(qry).done(function(data) {
                                $('#report_date').html(data.rows[0]._when.substr(0,10));
                            });
                            $('#report_status').html(getStatus(data.status));
                            $('#report_via').html(getVia(data.via));
                            $('#followBtn').html('Seguir');

                            $('#modal3').openModal();
                            loadComments($('#report_ticket').val());
                            getgSV(latlng)

                            if (document.getElementById('close-city')) document.getElementById('close-city').click();
                            if (document.getElementById('close-cic')) document.getElementById('close-cic').click();
                        }

                        function getStatus(st){
                            switch(st){
                                case 'open':
                                    return 'Abierto';   
                                case 'halted':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #ffc107";
                                    return 'En espera <i class="mdi-action-assignment amber-text"></i>';
                                case 'assigned':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #ffc107";
                                    return 'Asignado <i class="mdi-action-assignment-ind amber-text"></i>';
                                case 'spam':
                                    return 'Spam';
                                case 'archived':
                                    return 'Archivado';
                                case 'forgot':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #F44336";
                                    return 'Olvidado <i class="mdi-action-assignment-returned red-text"></i>';
                                case 'rejected':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #F44336";
                                    return 'Rechazado <i class="mdi-action-assignment-return red-text"></i>';
                                case 'working':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #ffc107";
                                    return 'En proceso <i class="mdi-action-assignment amber-text"></i>';
                                case 'answered':
                                    return 'Respondido';
                                case 'solved':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #4CAF50";
                                    return 'Resuelto <i class="mdi-action-assignment-turned-in green-text"></i>';
                                case 'failed':
                                    document.getElementById("modal3_content").style.borderLeft = "thick solid #F44336";
                                    return 'Fallo <i class="mdi-action-assignment-late red-text"></i>';
                            }
                        }

                        function getVia(via){
                            switch(via){
                                case 'web':
                                    return 'Web'
                                case 'whatsapp':
                                    return 'Whatsapp'
                                case 'phone':
                                    return 'Teléfono'
                                case 'street':
                                    return 'Alcalde en tu calle'
                                case 'networks':
                                    return 'Redes sociales'
                                case 'office':
                                    return 'Oficina'
                                case 'event':
                                    return 'Evento'
                                case 'letter':
                                    return 'Oficio'
                                case 'media':
                                    return 'Medios'
                            }
                        }

                        function loadComments(_id){
                            var url = "/report/comments/ticket/"+_id+"/";
                             $.ajax({
                                 url: url,
                                 type: 'GET',
                                 success: function(data) { 
                                     console.log(data)
                                 }
                             }).done(function(data) {
                                 $('#report_comments').html(data.logs.html);
                             });
                        }

                        {% if user_id %}

                            document.querySelector('#submit_report_form_comment').addEventListener('click', function() { 
                                if (document.getElementById("commentbox").value == '')
                                    Materialize.toast('<span class="toast-warning">Oops! Por favor escribe tu comentario primero.</span>',4500);
                                else{
                                    var url = "{{ uri_for('materialize-report-comments-add') }}?ticket="+$('#report_ticket').val()+"&comment=" + document.getElementById("commentbox").value;
                                     $.ajax({
                                         url: url,
                                         type: 'GET',
                                         success: function(data) { 
                                             console.log(data)
                                         }
                                     }).done(function(data) {
                                         if (data.status == 'success'){
                                            loadComments($('#report_ticket').val());
                                            $('#commentbox').val('');
                                            Materialize.toast('<span class="toast-success">Gracias por tus comentarios.</span>',4500);
                                         }else{
                                            Materialize.toast('<span class="toast-warning">Algo ha sucedido, por favor intenta de nuevo.</span>',4500);
                                         }
                                     });
                                }                               
                            });

                        {% endif %}

                        function getgSV(location) {
                            var loc = new google.maps.LatLng(location[0], location[1]);
                            var _gsv = false;
                            sv.getPanoramaByLocation(loc, 50, function(data, status) {
                                if (status == google.maps.StreetViewStatus.OK) {
                                    $('#gSV').show();
                                    panorama = new google.maps.StreetViewPanorama(
                                        document.getElementById('gSVpanorama'), {
                                            position: loc,
                                            addressControlOptions: {
                                              position: google.maps.ControlPosition.BOTTOM_CENTER
                                            },
                                            linksControl: false,
                                            panControl: false,
                                            enableCloseButton: true,
                                            scrollwheel: false,
                                            zoomControl: false,
                                            fullScreenControl: false
                                        }
                                    );
                                    _gsv = true;
                                }else{
                                    $('#gSV').hide();
                                    _gsv = false;
                                }
                            });
                            return _gsv;
                        }

                        function followReport(elem){
                            var kind;
                            if (elem.innerHTML.indexOf('Seguir') >= 0){
                                kind = 'follow';
                            }
                            else if (elem.innerHTML.indexOf('Dejar de seguir') >= 0){
                                kind = 'unfollow';
                            }
                            else{
                                kind = 'none';
                            }

                            $.ajax({
                                url: "{{ uri_for('materialize-report-follow') }}",
                                type: 'POST',
                                data: { 
                                    'report_id': $('#report_ticket').val(),
                                    'user_id': {{user_id}},
                                    '_csrf_token': '{{ csrf_token() }}',
                                    'kind': kind
                                }
                            }).done(function(data) {
                                console.log(data);
                                if (kind == 'follow' && data.status == 'success' && data.contents != 'user is creator'){
                                    elem.innerHTML = elem.innerHTML.replace('Seguir','Dejar de seguir');
                                }
                                if (kind == 'unfollow' && data.status == 'success' && data.contents != 'user is creator'){
                                    elem.innerHTML = elem.innerHTML.replace('Dejar de seguir', 'Seguir');
                                }
                                var qry = "SELECT follows FROM " + city_table_name + " WHERE cartodb_id = " + $('#report_ticket').val();
                                city_sql.execute(qry).done(function(data) {
                                    $('#report_followers').html(data.rows[0].follows);
                                    $('#report_follows').val(data.rows[0].follows)
                                });
                                if (data.contents == 'user already following')
                                    Materialize.toast('<span class="toast-warning">Oops! Ya sigues este reporte.</span>',4500);
                                else if (data.contents == 'follow request successful')
                                    Materialize.toast('<span class="toast-success">Bravo! Ahora podrás verlo en tus reportes.</span>',4500);
                                else if (data.contents == 'unfollow request successful')
                                    Materialize.toast('<span class="toast-success">Has dejado de seguir este reporte.</span>',4500);
                                else if (data.contents == 'user is creator')
                                    Materialize.toast('<span class="toast-success">Tú creaste este reporte, ya se encuentra en tus reportes.</span>',4500);
                            });
                        }

                        {% if has_address %}
                            function myZone(){
                                if (zoned){
                                    zoned = false;    
                                    $('#my-zone').html('<i class="mdi-navigation-fullscreen"></i> Ver mi colonia');
                                    $('#my-zone-m').html('<i class="mdi-navigation-fullscreen"></i> Ver mi colonia');
                                }                       
                                else{
                                    zoned = true;    
                                    $('#my-zone').html('<i class="mdi-navigation-fullscreen"></i> Reestablecer mapa');
                                    $('#my-zone-m').html('<i class="mdi-navigation-fullscreen"></i> Reestablecer mapa');
                                }

                                Q();
                            }
                        {% endif %}
                        
                        function updateCounters(q){
                            var nq = q.replace('SELECT *', 'SELECT count(*)');
                            city_sql.execute(nq).done(function(data) {
                                
                                var add = 0;
                                $('#c_alcalde').html(data.rows[0].count);
                                $('#c_alcalde_M').html(data.rows[0].count);
                                
                                add += document.getElementById('check_alcalde').checked ? data.rows[0].count : 0;
                                add += document.getElementById('check_cic').checked ? Number($('#c_cic').html()) : 0;
                                
                                $('#rep_count').html(addCommas(add));
                                $('#rep_count_M').html(addCommas(add));
                            })                     
                            
                        }
                                            
                        function Q(){
                            var cCss;
                            var auxWhere = true;
                            var q = "SELECT * FROM " + city_table_name + "  WHERE status not in ('spam', 'archived', 'forgot') AND pvt = false";

                            //Hide CIC
                            if(sublayers[1]) sublayers[1].hide();
                            document.getElementById('check_cic').checked = false;
                            
                            
                            //Zone
                            if (zoned){
                                var coof = "{{address_from_coord}}";
                                var m1 = coof.split(',').map(Number);           
                                q+= " AND ( ST_Intersects("+city_table_name+".the_geom,ST_Buffer( ST_SetSRID('POINT("+m1[1]+" "+m1[0]+")'::geometry , 4326),0.007194572847353697)))";   
                            }

                            //Dates
                            if (document.getElementById('calendar').checked){
                                var from = document.getElementById('from').value;
                                var until = document.getElementById('until').value;
                                if (from && until){
                                    if (auxWhere) {
                                        q += " AND ";
                                    } else {
                                        q += " WHERE ";                        
                                    }
                                    q += "_when BETWEEN SYMMETRIC ('"+from+"') AND ('"+until+"')";
                                    auxWhere = true;
                                }
                            }
                            
                            //Categories
                            var groupList = document.getElementsByClassName("filterGroup");
                            var t, groupGrp=[];                        
                            for (var i = 0, j = groupList.length;i<j;i++){
                                if(groupList[i].checked){
                                    if (auxWhere) {
                                        t = " AND ";
                                    } else {
                                        t = " WHERE ";                        
                                    }                        
                                    groupGrp.push("'" + groupList[i].id  + "'");
                                }
                            }
                            if (groupGrp.length>0) {
                                t += "group_category IN (" + groupGrp.join() + ")";
                                auxWhere = true;
                                q += t;
                            }

                            //Subcategories
                            var categoryList = document.getElementsByClassName("filterCategory");
                            var t, categoryGrp=[];                        
                            for (var i = 0, j = categoryList.length;i<j;i++){
                                if(categoryList[i].checked){
                                    if (auxWhere) {
                                        t = " AND ";
                                    } else {
                                        t = " WHERE ";                        
                                    }                        
                                    categoryGrp.push("'" + categoryList[i].id  + "'");
                                }
                            }
                            if (categoryGrp.length>0) {
                                t += "sub_category IN (" + categoryGrp.join() + ")";
                                auxWhere = true;
                                q += t;
                            }
                            
                            //Status
                            var statusList = document.getElementsByClassName("filterStatus");
                            var t, statusGrp=[];                        
                            for (var i = 0, j = statusList.length;i<j;i++){
                                if(statusList[i].checked){
                                    if (auxWhere) {
                                        t = " AND ";
                                    } else {
                                        t = " WHERE ";                        
                                    }                        
                                    statusGrp.push("'" + statusList[i].id  + "'");
                                }
                            }
                            if (statusGrp.length>0) {
                                t += "status IN (" + statusGrp.join() + ")";
                                auxWhere = true;
                                q += t;
                            }
                            query = q;    
                            updateCounters(q);
                            console.log(q);
                            if (sublayers[2]) sublayers[2].setSQL(q);
                            
                        }   
                    </script>
                    <script type="infowindow/html" id="infowindow_{{cartodb_cic_reports_table}}">
                        {% raw %}
                        <div class="cartodb-popup v2"> 
                            <a id="close-cic" href="#close" class="cartodb-popup-close-button close">x</a> 
                            <div class="cartodb-popup-header"> 
                                <p style="color:#DDDDDD; padding-left:10px; margin-bottom:-20px">Categoría</p> 
                                <h3 style="padding:10px;" class="brand-secondary-color-text">{{post_cat}}</h3> 
                                <span class="separator"></span> 
                            </div> 
                            <div class="cartodb-popup-content-wrapper"> 
                                <div class="cartodb-popup-content">                            
                                    <p style="color:#DDDDDD; padding-left:10px; margin-bottom:-10px">Descripción</p> 
                                    <h4 style="padding:10px;" class="brand-secondary-color-text">{{post_title}}</h4>
                                    <p style="color:#DDDDDD; padding-left:10px; margin-bottom:-10px">Canal</p> 
                                    <h4 style="padding:10px;" class="brand-secondary-color-text">{{channel}}</h4>  
                                    <p style="color:#DDDDDD; padding-left:10px; margin-bottom:-20px">Vía</p> 
                                    <a href="http://developers.cic.mx" target="_blank"> 
                                    <img style="width: 40%; padding:10px;background: #CDD0D0; border-radius: 40px;margin-top: 15px;" src="http://www.cic.mx/wp-content/themes/cic-theme/media/logo.png"> 
                                    </a>
                                </div> 
                            </div> 
                            <div class="cartodb-popup-tip-container"> </div> 
                        </div> 
                        {% endraw %}  
                    </script>
                    <script type="infowindow/html" id="infowindow_{{cartodb_reports_table}}">
                        {% raw %}
                        <div class="cartodb-popup v2" style="display:none;"> 
                            <a id="close-city" href="#close" class="cartodb-popup-close-button close">x</a> 
                            <div class="cartodb-popup-header"> 
                                <p style="color:#DDDDDD; padding-left:10px; margin-bottom:-20px">Grupo</p> 
                                <h3 style="padding:10px;" class="brand-secondary-color-text">{{group_category}}</h3> 
                                <span class="separator"></span> 
                            </div> 
                            <div class="cartodb-popup-content-wrapper"> 
                                <div class="cartodb-popup-content">                            
                                    <p style="color:#DDDDDD; padding-left:10px; margin-bottom:-10px">Categoría</p> 
                                    <h4 style="padding:10px;" class="brand-secondary-color-text">{{sub_category}}</h4> 
                                </div> 
                            </div> 
                            <div class="cartodb-popup-tip-container"> </div> 
                        </div> 
                        {% endraw %}  
                    </script>
                {% endif %}
                
{% endblock %}  