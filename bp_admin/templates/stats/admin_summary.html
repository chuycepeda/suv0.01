{% extends 'admin_base.html' %}

{% block breadcrums %}
    <!--breadcrumbs start-->
    <div id="breadcrumbs-wrapper" class=" grey lighten-3" style="  min-height: 70px;">
        <div class="container">
            <div class="row">
              <div class="col s12 m12 l12">
                <ol class="breadcrumb" style="font-size: 29px;">
                    <li class="active">Resumen estadístico</li>
                </ol>
            </div>
        </div>
    </div>
    <!--breadcrumbs end-->
{% endblock %}

{% block page_css %}
    <style>
        .btn{
                margin-right: 10px;
        }
    </style>
{% endblock %}

{% block page_content %}
    <div class="row center" style="border-top: 1px dashed rgb(216, 216, 216);padding-top: 20px;">
        <div class="row brand-color center" style="margin-top: -20px;padding: 40px;margin-bottom: 22px;"><h5 class="white-text" style="line-height: 0px;">Números globales</h5>
            <span class="col s12 m6 indicator flow-text white-text" style="text-align:center; font-size:40px;"><h6>Usuarios registrados</h6>{{sum_users}}</span>
            <span class="col s12 m6 indicator flow-text white-text" style="text-align:center; font-size:40px;"><h6>Reportes recibidos</h6>{{sum_reports}}</span>
        </div>
        <div class="col s12 m3 card brand-color-text valign-wrapper" style="text-align:center; font-size:40px; min-height:256px;">
            <div class="col s12">
               <h5>Reportes validados:</h5>
                <span class="indicator flow-text" id="totalReports" style="text-align:center; font-size:50px;">
                    <div class="preloader-wrapper small active" style="margin-top: 5px;">
                        <div class="spinner-layer spinner-red-only">
                          <div class="circle-clipper left">
                            <div class="circle"></div>
                          </div><div class="gap-patch">
                            <div class="circle"></div>
                          </div><div class="circle-clipper right">
                            <div class="circle"></div>
                          </div>
                        </div>
                    </div>
                </span>
            </div>
        </div>
        <div class="col s12 m9">
            <div id="statuses" class="card-panel">
                <div class="row">
                    <div class="col s12">
                        <span class="card-title left">
                            <span style=" font-size: 25px; font-family: roboto-light;">Selecciona una fecha</span>
                        </span>
                    </div>                
                    <div class="input-field col s6">
                        <input id="from" type="date" class="datepicker filterDate">
                        <label for="from">Desde</label>
                    </div>
                    <div class="input-field col s6">
                        <input id="until" type="date" class="datepicker filterDate">
                        <label for="until">Hasta</label>
                    </div> 
                </div>
                <div class="row" style="text-align: left;">
                    <div class="col s12">
                        <ul class="collapsible collapsible-accordion" data-collapsible="accordion" style="border: none;box-shadow: none;">
                            <li class="">
                                <div class="collapsible-header">Selecciona un estado de reporte.</div>
                                <div class="collapsible-body">
                                    <div class="section">                            
                                        <div class="row">
                                            <div class="container" style="text-align: left;">
                                                <p class="col s12 m3"><input class="filterStatus" type="checkbox" id="halted"><label for="halted">En espera</label></p>
                                                <p class="col s12 m3"><input class="filterStatus" type="checkbox" id="answered"><label for="answered">Respondido</label></p>
                                                <p class="col s12 m3"><input class="filterStatus" type="checkbox" id="assigned"><label for="assigned">Asignado</label></p>
                                                <p class="col s12 m3"><input class="filterStatus" type="checkbox" id="solved"><label for="solved">Resuelto</label></p>
                                                <p class="col s12 m3"><input class="filterStatus" type="checkbox" id="rejected"><label for="rejected">Rechazado</label></p>
                                                <p class="col s12 m3"><input class="filterStatus" type="checkbox" id="archived"><label for="archived">Archivado</label></p>
                                                <p class="col s12 m3"><input class="filterStatus" type="checkbox" id="working"><label for="working">En proceso</label></p>
                                                <p class="col s12 m3"><input class="filterStatus" type="checkbox" id="failed "><label for="failed ">Fallo</label></p>         
                                                <p class="col s12 m3"><input class="filterStatus" type="checkbox" id="spam"><label for="spam">Spam</label></p>            
                                                <p class="col s12 m3"><input class="filterStatus" type="checkbox" id="forgot"><label for="forgot">Olvidado</label></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <button class="waves-effect waves-light btn filterControl right" id="calendar"><i class="mdi-content-send right"></i>Filtrar</button>                
                    <button class="waves-effect waves-light btn filterControl right" id="clean">Limpiar</button>                
                </div>
            </div>                    
        </div>
    </div>
    
    <div class="section">
        <div class="row">
            <div class="card col s12 l6">
                <div class="row">
                    <div class="container">
                        <div class="col s12">
                            <p class="caption center">Reportes por vía.</p>
                            <div id="container-pie-via"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card col s12 l6">
                <div class="row">
                    <div class="container">
                        <div class="col s12">
                            <p class="caption center">Reportes por estado.</p>
                            <div id="container-pie-status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="section">
        <div class="card">
            <a class="waves-effect waves-light btn right" id ="pieornot">Ver como pay</a>
            <div class="row">
                <div class="container">
                    <div class="col s12">
                        <p class="caption center">Reportes por Secretaría.</p>
                        <div id="container-drilldown" style="height: 600px"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="section">
        <div class="card">
            <a class="waves-effect waves-light btn right" id ="perf_pieornot">Ver como pay</a>
            <div class="row">
                <div class="container">
                    <div class="col s12">
                        <p class="caption center" id ="perf_title">Días promedio en cerrar reportes por Secretaría en los últimos 90 días.</p>
                        <div id="perf_container-drilldown" style="height: 600px"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="section">
        <div class="card">
            <div class="row">
                <div class="col s12">
                    <a class="btn dropdown-button waves-effect waves-light right" href="#!" data-activates="ratingDdown">Exporta en .CSV<i class="mdi-navigation-arrow-drop-down right"></i></a>
                    <ul id="ratingDdown" class="dropdown-content">
                        <li><button class="rating-exp waves-effect waves-light btn white-text col s12" id ="rating-tickets_5" onclick="exportCSV(this.id)" >5 <i class="mdi-action-star-rate"></i><i class="mdi-action-star-rate"></i><i class="mdi-action-star-rate"></i><i class="mdi-action-star-rate"></i><i class="mdi-action-star-rate"></i></button></li>
                        <li> <button class="rating-exp waves-effect waves-light btn white-text col s12" id ="rating-tickets_4" onclick="exportCSV(this.id)" >4 <i class="mdi-action-star-rate"></i><i class="mdi-action-star-rate"></i><i class="mdi-action-star-rate"></i><i class="mdi-action-star-rate"></i></button></li>
                        <li><button class="rating-exp waves-effect waves-light btn white-text col s12" id ="rating-tickets_3" onclick="exportCSV(this.id)" >3 <i class="mdi-action-star-rate"></i><i class="mdi-action-star-rate"></i><i class="mdi-action-star-rate"></i></button></li>
                        <li><button class="rating-exp waves-effect waves-light btn white-text col s12" id ="rating-tickets_2" onclick="exportCSV(this.id)" >2 <i class="mdi-action-star-rate"></i><i class="mdi-action-star-rate"></i></button></li>
                        <li><button class="rating-exp waves-effect waves-light btn white-text col s12" id ="rating-tickets_1" onclick="exportCSV(this.id)" >1 <i class="mdi-action-star-rate"></i></button></li>
                    </ul>            
                </div>
            </div>   
            <div class="row">
                <div class="container">
                    <div class="col s12">
                        <p class="caption center">Nivel de satisfacción.</p>
                        <div id="container-pie-rating"></div>
                    </div>                                   
                </div>                    
            </div>
        </div>
    </div>
{% endblock %}

{% block page_floatings %}
{% endblock %}

{% block page_scripts %}
    <script src="/{{theme}}/materialize/js/cartodb.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/drilldown.js"></script>
    <script>

        //GLOBALS        
        var statuses = "";
        var sec = {};
        var perf_sec = {};
        var dict;
        var chartType = 'bar';
        var allDone = {
            'container-pie-via' : false,
            'container-pie-status': false,
            'container-drilldown': false,
            'perf_container-drilldown': false,
        }
        var city_user = '{{cartodb_user}}';
        var city_table_name = '{{cartodb_reports_table}}';
        var city_mun_table_name = '{{cartodb_polygon_table}}';
        var city_polygon_name = '{{cartodb_polygon_name}}'
        var city_sql = new cartodb.SQL({ user: '{{cartodb_user}}' });
                        
        function createDrilldown(data,container,chartType){
            
            var seriesData = [];
            var seriesDdAg = [];
                        
            for (var x in data){
                if (data[x].totalReports > 0){
                    //main series
                    seriesData.push({
                       name: x,
                       y: data[x].totalReports,
                       drilldown: x
                    });
                    
                    //Drilldown fun
                    seriesDdAg.push({
                        id: x,
                        name: x,
                    });
                    tdata = [];
                    
                    for (var ag in data[x]){
                        if (ag!='totalReports'){
                            tdata.push({
                                name: ag,
                                y: data[x][ag]['totalReports'],
                                drilldown: ag
                            });
                        }
                    }    
                    seriesDdAg[seriesDdAg.length-1]['data']=tdata;
                
                    for (var ag in data[x]){
                        seriesDdAg.push({
                            id: ag,
                            name: ag
                        });
                        tdata2=[];
                        for (var cat in data[x][ag]){
                            if (cat!='totalReports'){
                                tdata2.push({
                                    name: cat,
                                    y: data[x][ag][cat],
                                });
                            }
                        }
                        seriesDdAg[seriesDdAg.length-1]['data']=tdata2;
                    }
                }    
            }
            
            $('#'+container).highcharts({
                chart: {
                    type: chartType,
                },
                title: {
                    text: null
                },
                subtitle: {
                    text: 'Haz clic sobre los elementos de la gráfica para entrar en detalle.'
                },
                tooltip: {
                    formatter: function() {
                        return this.point.name + '<br>Reportes: <b>' + this.y + '</b>';
                    }
                },                
                xAxis: {
                    type: 'category',
                    labels: {
                          style: {
                            "textOverflow": "none"
                          },
                    } 
                },
                yAxis: {
                    title: {
                        text: 'Reportes',
                    }
                },
                legend: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        borderWidth: 0,
                        dataLabels: {
                            enabled: true,
                        }
                    }
                },
                series: [{
                    name: 'Secretarias',
                    colorByPoint: true,
                    data: seriesData
                }],
                drilldown: {
                    
                    drillUpButton: {
                        relativeTo: 'spacingBox',
                        position: {
                            y: 0,
                            x: 0
                        },
                        theme: {
                            fill: 'white',
                            'stroke-width': 1,
                            stroke: 'silver',
                            r: 0,
                            states: {
                                hover: {
                                    fill: '{{brand_secondary_color}}'
                                },
                                select: {
                                    stroke: '#039',
                                    fill: '{{brand_secondary_color}}'
                                }
                            }
                        }
        
                    },                    
                    series: seriesDdAg
                }
            }, function (chart) {
                //After chart is done set flag
                allDone[container] = true;
                //console.log("Chart "+container+" done");
            });            
        }
        
        function createPerfDrilldown(data,container,chartType){
            
            var seriesData = [];
            var seriesDdAg = [];
                        
            for (var x in data){
                if (data[x].avgReports > 0){
                    //main series
                    seriesData.push({
                       name: x,
                       y: data[x].avgReports,
                       drilldown: x
                    });
                    
                    //Drilldown fun
                    seriesDdAg.push({
                        id: x,
                        name: x,
                    });
                    tdata = [];
                    
                    for (var ag in data[x]){
                        if (ag!='avgReports'){
                            tdata.push({
                                name: ag,
                                y: data[x][ag]['avgReports'],
                                drilldown: ag
                            });
                        }
                    }    
                    seriesDdAg[seriesDdAg.length-1]['data']=tdata;
                
                    for (var ag in data[x]){
                        seriesDdAg.push({
                            id: ag,
                            name: ag
                        });
                        tdata2=[];
                        for (var cat in data[x][ag]){
                            if (cat!='avgReports'){
                                tdata2.push({
                                    name: cat,
                                    y: data[x][ag][cat],
                                });
                            }
                        }
                        seriesDdAg[seriesDdAg.length-1]['data']=tdata2;
                    }
                }    
            }
            
            $('#'+container).highcharts({
                chart: {
                    type: chartType,
                },
                title: {
                    text: null
                },
                subtitle: {
                    text: 'Haz clic sobre los elementos de la gráfica para entrar en detalle.'
                },
                tooltip: {
                    formatter: function() {
                        return this.point.name + '<br>Tiempo promedio en cerrar: <b>' + this.y + '</b> días';
                    }
                },                
                xAxis: {
                    type: 'category',
                    labels: {
                          style: {
                            "textOverflow": "none"
                          },
                    } 
                },
                yAxis: {
                    title: {
                        text: 'Dias',
                    }
                },
                legend: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        borderWidth: 0,
                        dataLabels: {
                            enabled: true,
                        }
                    }
                },
                series: [{
                    name: 'Secretarias',
                    colorByPoint: true,
                    data: seriesData
                }],
                drilldown: {
                    
                    drillUpButton: {
                        relativeTo: 'spacingBox',
                        position: {
                            y: 0,
                            x: 0
                        },
                        theme: {
                            fill: 'white',
                            'stroke-width': 1,
                            stroke: 'silver',
                            r: 0,
                            states: {
                                hover: {
                                    fill: '{{brand_secondary_color}}'
                                },
                                select: {
                                    stroke: '#039',
                                    fill: '{{brand_secondary_color}}'
                                }
                            }
                        }
        
                    },                    
                    series: seriesDdAg
                }
            }, function (chart) {
                //After chart is done set flag
                allDone[container] = true;
                //console.log("Chart "+container+" done");
            });            
        }
        
        function createBar(dataBar,container){
            dataBar = dataBar||{};
            var dataSeries=[];
            var catSeries=[];
            for (var x in dataBar){
                dataSeries.push(dataBar[x]);
                catSeries.push(x);
            }
            
            // Build the chart
            $('#'+container).highcharts({
                chart: {
                    type: 'bar',
                },
                title: {
                    text: null
                },
                xAxis: {
                    categories: catSeries,
                    title: {
                        text: null
                    }
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: null
                    },
                },
                tooltip: {
                },
                plotOptions: {
                    bar: {
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                legend: {
                    enabled: false
                },
                credits: {
                    enabled: false
                },
                series: [{
                    name: 'Reportes',
                    data: dataSeries
                }]
            }, function (chart) {
                //After chart is done set flag
                allDone[container] = true;
                //console.log("Chart "+container+" done");
            });
        }

        function createPie(dataPie,container){
            dataPie = dataPie||{};
            var dataSeries=[];
            for (var x in dataPie){
                dataSeries.push({name:x,y:dataPie[x]})
            }
            
            // Build the chart
            $('#'+container).highcharts({
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie',
                    events: {
                        load: function(event) {
                            allDone[container] = true;

                            }
                    }  
                },
                title: {
                    text: null
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.y}',
                        },
                        showInLegend: true
                    }
                },
                series: [{
                    name: 'Porcentaje',
                    colorByPoint: true,
                    data: dataSeries
                }]
            }, function (chart) {
                //After chart is done set flag
                allDone[container] = true;
                //console.log("Chart "+container+" done");
            });
        }
        
        function sumProp(obj) {
            var sum = 0;
            for( var x in obj ) {
                if( obj.hasOwnProperty(x) ) {
                    sum += parseFloat( obj[x] );
                }
            }
            return sum;
        }        
        
        function countProp(obj) {
            var count = 0;
            for( var x in obj ) {
                if( obj.hasOwnProperty(x) ) {
                    count += 1;
                }
            }
            return count;
        }        
        
        function getVia(via){
            var ds;
            switch (via) {
                case 'web':
                    ds = "Web";
                    break;
                case 'whatsapp':
                    ds = "Whatsapp";
                    break;
                case 'phone':
                    ds = "Teléfono";
                    break;
                case 'street':
                    ds = "Alcalde en tu calle";
                    break;
                case 'networks':
                    ds = "Redes sociales";
                    break;
                case 'office':
                    ds = "Oficina";
                    break;
                case 'event':
                    ds = "Evento";
                    break;
                case 'letter':
                    ds = "Oficio";
                    break;
                case 'media':
                    ds = "Medios";
                    break;
                default: ds="";
                    break
            }
            return ds;
        }    
        
        function getStatus(status){
            var ds;
            switch (status) {
                case 'open':
                    ds = "Abierto";
                    break;
                case 'answered':
                    ds = "Respondido";
                    break;
                case 'spam':
                    ds = "Spam";
                    break;
                case 'halted':
                    ds = "En espera";
                    break;
                case 'assigned':
                    ds = "Asignado";
                    break;
                case 'rejected':
                    ds = "Rechazado";
                    break;
                case 'solved':
                    ds = "Resuelto";
                    break;
                case 'failed':
                    ds = "Fallo";
                    break;
                case 'archived':
                    ds = "Archivado";
                    break;
                case 'forgot':
                    ds = "Olvidado";
                    break;
                case 'working':
                    ds = "En proceso";
                    break;
                default: ds="";
                    break
            }
            return ds;
        }    
        
        function getData(source, when){
            
            var qs = 'SELECT '+source+' as prop, count(*) FROM '+city_table_name+ ' ';            
            if (when) qs += when; 
            qs += 'GROUP BY prop';
            city_sql.execute(qs).done(function(data) {
                
                var trans = {};
                for (var x = 0; x < data.total_rows;x++){
                    trans[data.rows[x]['prop']] = data.rows[x]['count'];
                }
                var pieData=[];
                var barData=[];
                var barCats=[];
                
                var data = trans;
                
                if (source == 'via') document.getElementById('totalReports').innerHTML = sumProp(trans);

                for (var x in data){
                    if (source=='via' || source == null) {
                        pieData.push({name:getVia(x),y:data[x]});
                        barCats.push(getVia(x));
                    }else if (source=='status') {
                        pieData.push({name:getStatus(x),y:data[x]})
                        barCats.push(getStatus(x));
                    }else if (source=='rating'){
                        var visible = true;
                        if (x == 0) visible = false;
                        pieData.push({name:x+' estrellas',y:data[x],visible: visible});
                    }else{
                        barCats.push(x);
                    }
                    barData.push(data[x]);                
                }
                                
                if (source=='via' || source == null) {
                    chartPieVia.series[0].setData(pieData);
                    chartPieVia.hideLoading();  
                }else if (source=='status') {
                    chartPieStatus.series[0].setData(pieData);
                    chartPieStatus.hideLoading();            
                }else if (source=='sub_category') {
                    chartBarSubcat.xAxis[0].setCategories(barCats);
                    chartBarSubcat.series[0].setData(barData);
                    chartBarSubcat.hideLoading();            
                }else if (source=='group_category') {
                    chartBarGroup.xAxis[0].setCategories(barCats);
                    chartBarGroup.series[0].setData(barData);
                    chartBarGroup.hideLoading();            
                }else if (source=='rating') {
                    chartPieRating.series[0].setData(pieData);
                    chartPieRating.hideLoading();            
                }
                
            }).error(function(errors) {
                // errors contains a list of errors
                //console.log("errors:" + errors);
            })            
        }

        function getRatingData(source, when){
            
            var qs = "SELECT "+source+" as prop, count(*) FROM  "+city_table_name+" WHERE status in ('solved') ";            
            if (when) qs += when.replace('WHERE', 'AND');             
            qs += 'GROUP BY prop';
            city_sql.execute(qs).done(function(data) {
        
                $('.rating-exp').prop('disabled',true);
                var trans = {};
                for (var x = 0; x < data.total_rows;x++){
                    trans[data.rows[x]['prop']] = data.rows[x]['count'];
                }
                var pieData=[];                
                var data = trans;

                for (var x in data){
                    var visible = true;
                    if (x == 0) visible = false;
                    else $('#rating-tickets_'+x).prop('disabled',false);
                    pieData.push({name:x+' estrellas',y:data[x],visible: visible});
                }
                                
                chartPieRating.series[0].setData(pieData);
                chartPieRating.hideLoading();            
                
            }).error(function(errors) {
                // errors contains a list of errors
                //console.log("errors:" + errors);
            })            
        }
        
        function getDict(){
            
            var url = "{{uri_for('materialize-report-categories')}}";
            $.ajax({
                url: url,
                type: 'GET',
            }).done(function(data) {
                //console.log('Dict from DS');
                //console.log(data);
                dict = data;
                getDrillData();
                getPerfDrillData();            
            });             
        }
        
        function parseDate(str) {
            var mdy = str.split('-')
            return new Date(mdy[0], mdy[1]-1, mdy[2]);
        }
        
        function daydiff(first, second) {
            return Math.round((second-first)/(1000*60*60*24));
        }        
        
        function getPerfDrillData(when){
            perf_sec = {};
            var s = "SELECT ceil(avg(date_part('days', (terminated - created)))) AS count, group_category, sub_category FROM "+city_table_name+" WHERE status IN ('solved', 'failed', 'archived') AND terminated is not null ";
            if (when){ 
                s+= when.replace('WHERE', 'AND');
                var days = daydiff(parseDate($('#from').val()), parseDate($('#until').val()));
                document.getElementById("perf_title").innerHTML = "Días promedio en cerrar reportes por Secretaría en los últimos "+days+" días.";
            }
            else{ 
                s+= "AND ( (now() - created) < interval '90 day')";
                document.getElementById("perf_title").innerHTML = "Días promedio en cerrar reportes por Secretaría en los últimos 90 días.";
            }
            s += " GROUP BY group_category, sub_category ORDER BY group_category ASC";
                        
            //console.log('s for performance: ', s);
            
            city_sql.execute(s).done(function(data) {
                //console.log('Data from CartoDB');
                //console.log(data);
                var grps = {};
                for (var x = 0; x < data.total_rows; x++){
                    grps[data.rows[x]['group_category']] = grps[data.rows[x]['group_category']] || {};
                    grps[data.rows[x]['group_category']][data.rows[x]['sub_category']] = data.rows[x]['count'];
                }
                //console.log('Groups from CartoDB');
                //console.log(grps);
                
                for (var y in dict){
                    perf_sec[dict[y]['secretaries'][0]] = perf_sec[dict[y]['secretaries'][0]] || {};
                    perf_sec[dict[y]['secretaries'][0]][dict[y]['agencies'][0]] = perf_sec[dict[y]['secretaries'][0]][dict[y]['agencies'][0]] || {};
                    perf_sec[dict[y]['secretaries'][0]][dict[y]['agencies'][0]] = grps[y]||{};
                }            
                //console.log('Secretaries Perf');
                //console.log(perf_sec);
                
                //Add for total report count
                for (var n in perf_sec){
                    var sumSec = 0;
                    if (perf_sec.hasOwnProperty(n)){
                       for (var m in perf_sec[n]){
                           var sumAg = 0;
                           var countAg = 0;
                           if (perf_sec[n].hasOwnProperty(m)){
                              sumAg = sumProp(perf_sec[n][m]);
                              countAg = countProp(perf_sec[n][m]);
                              //console.log(m);
                              //console.log(perf_sec[n][m]);
                              //console.log(countAg);
                              var avgRepAg = Math.round((sumAg/countAg) * 100) / 100;
                              perf_sec[n][m]['avgReports'] = isNaN(avgRepAg) ? 0 : avgRepAg;
                              //console.log('sumAg');
                              //console.log(sumAg);
                              sumSec += (sumAg/countAg);
                              //console.log('sumSec');
                              //console.log(sumSec);
                           }
                       }
                       countSec = countProp(perf_sec[n]);
                       //console.log('countSec');
                       //console.log(perf_sec[n]);
                       //console.log(countSec); 
                       var avgRepSec = Math.round((sumSec/countSec) * 100) / 100;
                       perf_sec[n]['avgReports'] = isNaN(avgRepSec) ? 0 : avgRepSec; 
                    }
                }
                if (perf_sec.hasOwnProperty('undefined')) {
                    if (perf_sec['undefined'].hasOwnProperty('undefined')) {
                        perf_sec['undefined']['Sin asignar'] = perf_sec['undefined']['undefined'];
                        delete perf_sec['undefined']['undefined'];
                    }
                    perf_sec['Sin Secretaria'] = perf_sec['undefined'];
                    delete perf_sec['undefined'];
                }
                createPerfDrilldown(perf_sec,'perf_container-drilldown',chartType);            
   
            
            }).error(function(errors) {
                // errors contains a list of errors
                //console.log("errors:" + errors);
            })            
        }
        
        function getDrillData(when){
            sec = {};
            var s = "SELECT group_category, sub_category, count(*) FROM " + city_table_name +" ";
            if (when) s+= when;
            s += "GROUP BY group_category, sub_category ORDER BY group_category asc";
            
            city_sql.execute(s).done(function(data) {
                //console.log('Data from CartoDB');
                //console.log(data);
                var grps = {};
                for (var x = 0; x < data.total_rows; x++){
                    grps[data.rows[x]['group_category']] = grps[data.rows[x]['group_category']] || {};
                    grps[data.rows[x]['group_category']][data.rows[x]['sub_category']] = data.rows[x]['count'];
                }
                //console.log('Groups from CartoDB');
                //console.log(grps);
                
                for (var y in dict){
                    sec[dict[y]['secretaries'][0]] = sec[dict[y]['secretaries'][0]] || {};
                    sec[dict[y]['secretaries'][0]][dict[y]['agencies'][0]] = sec[dict[y]['secretaries'][0]][dict[y]['agencies'][0]] || {};
                    sec[dict[y]['secretaries'][0]][dict[y]['agencies'][0]] = grps[y]||{};
                }            
                //console.log('Secretaries');
                //console.log(sec);
                
                //Add for total report count
                for (var n in sec){
                    var sumSec = 0;
                    if (sec.hasOwnProperty(n)){
                       for (var m in sec[n]){
                           var sumAg = 0;
                           if (sec[n].hasOwnProperty(m)){
                              sumAg = sumProp(sec[n][m]);
                              sec[n][m]['totalReports'] = sumAg;
                              sumSec += sumAg;
                           }
                       } 
                       sec[n]['totalReports'] = sumSec;
                    }
                }
                if (sec.hasOwnProperty('undefined')) {
                    if (sec['undefined'].hasOwnProperty('undefined')) {
                        sec['undefined']['Sin Direccion'] = sec['undefined']['undefined'];
                        delete sec['undefined']['undefined'];
                    }
                    sec['Sin Secretaria'] = sec['undefined'];
                    delete sec['undefined'];
                }
                createDrilldown(sec,'container-drilldown',chartType);            
   
            
            }).error(function(errors) {
                // errors contains a list of errors
                //console.log("errors:" + errors);
            })            
        }
        
        function allTrue(obj) {
             for(var o in obj){
               if( obj.hasOwnProperty(o) ) {
                 if(!obj[o]) return false;
               }
             }
             return true;
        }
        
        function pollforall(){
            var poll = setInterval(function() {
                if( allTrue(allDone) ) {
                    $('#calendar').attr('disabled',false);
                    $('#clean').attr('disabled',false);
                    window.clearInterval(poll);
                }
            }, 100);            
        }
        
        function destroyAndCreate(source){
            var when;
            var perf_when;
            $('#calendar').attr('disabled',true);
            $('#clean').attr('disabled',true);
            pollforall();
            if (source=='calendar'){
                var from = document.getElementById('from').value;
                var until = document.getElementById('until').value;
                if (from && until){
                    when = "WHERE _when BETWEEN SYMMETRIC ('"+from+"') AND ('"+until+"')";
                    perf_when = when;
                    if (statuses != ''){
                      when += " AND status IN (" + statuses.join() + ")";
                    }
                }  
            }else if (source == 'clean'){
                $('#from').val("");
                $('#until').val("");
            }
            
            chartPieVia = $('#container-pie-via').highcharts();
            chartPieStatus = $('#container-pie-status').highcharts();
            chartDdown = $('#container-drilldown').highcharts();
            chartPieRating = $('#container-pie-rating').highcharts();
            
            chartPieVia.destroy();
            chartPieStatus.destroy();
            chartDdown.destroy();
            chartPieRating.destroy();
            
            for (var x in allDone){
                allDone[x]=false;
            }
            
            createPie(null,'container-pie-via');
            chartPieVia = $('#container-pie-via').highcharts();
            chartPieVia.showLoading('Cargando datos...');
            getData('via',when);

            createPie(null,'container-pie-status');
            chartPieStatus = $('#container-pie-status').highcharts();
            chartPieStatus.showLoading('Cargando datos...');
            getData('status',when);

            createPie(null,'container-pie-rating');
            chartPieRating = $('#container-pie-rating').highcharts();
            chartPieRating.showLoading('Cargando datos...');
            getRatingData('rating',perf_when);  
                        
            getDrillData(when);
            getPerfDrillData(perf_when);
        }
        
        function exportCSV(rating) {
            rating = rating.substring(rating.search("_")+1);
            var qs = "SELECT cartodb_id AS ticket FROM "+city_table_name+" WHERE status IN ('solved') AND rating = "+rating+" ORDER BY ticket DESC";    
            city_sql.execute(qs).done(function(data) {
                console.log(data);
                writeCSV(data.rows,'Tickets '+rating+' Estrellas', data.total_rows, true);
            }).error(function(errors) {
                // errors contains a list of errors
                console.log("errors:" + errors);
            }) 
        }

        function writeCSV(JSONData, ReportTitle, totalTickets, ShowLabel) {
            //If JSONData is not an object then JSON.parse will parse the JSON string in an Object
            var arrData = typeof JSONData != 'object' ? JSON.parse(JSONData) : JSONData;
            
            var CSV = '';    
            //Set Report title in first row or line
            
            CSV += ReportTitle + ' ('+totalTickets+')' + '\r\n\n';

            //This condition will generate the Label/Header
            if (ShowLabel) {
                var row = "";
                
                //This loop will extract the label from 1st index of on array
                for (var index in arrData[0]) {
                    
                    //Now convert each value to string and comma-seprated
                    row += index + ',';
                }

                row = row.slice(0, -1);
                
                //append Label row with line break
                CSV += row + '\r\n';
            }
            
            //1st loop is to extract each row
            for (var i = 0; i < arrData.length; i++) {
                var row = "";
                
                //2nd loop will extract each column and convert it in string comma-seprated
                for (var index in arrData[i]) {
                    row += '"' + arrData[i][index] + '",';
                }

                row.slice(0, row.length - 1);
                
                //add a line break after each row
                CSV += row + '\r\n';
            }

            if (CSV == '') {        
                alert("Invalid data");
                return;
            }   
            
            //Generate a file name
            var fileName = "Reporte_";
            //this will remove the blank-spaces from the title and replace it with an underscore
            fileName += ReportTitle.replace(/ /g,"_");   
            
            //Initialize file format you want csv or xls
            var uri = 'data:text/csv;charset=utf-8,' + escape(CSV);
            
            // Now the little tricky part.
            // you can use either>> window.open(uri);
            // but this will not work in some browsers
            // or you will not get the correct file extension    
            
            //this trick will generate a temp <a /> tag
            var link = document.createElement("a");    
            link.href = uri;
            
            //set the visibility hidden so it will not effect on your web-layout
            link.style = "visibility:hidden";
            link.download = fileName + ".csv";
            
            //this part will append the anchor tag and remove it after automatic click
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        //Initial setup on DOM ready
        $(document).ready(function(){   
            
            Highcharts.setOptions({
                lang: {
                    drillUpText: '◁ Regresar a {series.name}'
                }
            });            
            
            getDict();
            
            createPie(null,'container-pie-via');
            chartPieVia = $('#container-pie-via').highcharts();
            chartPieVia.showLoading('Cargando datos...');
            getData('via');

            createPie(null,'container-pie-status');
            chartPieStatus = $('#container-pie-status').highcharts();
            chartPieStatus.showLoading('Cargando datos...');
            getData('status');
            
            createPie(null,'container-pie-rating');
            chartPieRating = $('#container-pie-rating').highcharts();
            chartPieRating.showLoading('Cargando datos...');
            getRatingData('rating');
                                    
            $('#pieornot').click(function(){
                chartDdown = $('#container-drilldown').highcharts();
                chartDdown.destroy();
                if (chartType == 'bar'){
                    chartType = 'pie';
                    createDrilldown(sec,'container-drilldown',chartType);
                    this.innerHTML = 'Ver como barras';
                   
                }else{
                    chartType = 'bar';
                    createDrilldown(sec,'container-drilldown',chartType);
                    this.innerHTML = 'Ver como pay';
                }
            });
            
            $('#perf_pieornot').click(function(){
                chartDdown = $('#perf_container-drilldown').highcharts();
                chartDdown.destroy();
                if (chartType == 'bar'){
                    chartType = 'pie';
                    createPerfDrilldown(perf_sec,'perf_container-drilldown',chartType);
                    this.innerHTML = 'Ver como barras';
                   
                }else{
                    chartType = 'bar';
                    createPerfDrilldown(perf_sec,'perf_container-drilldown',chartType);
                    this.innerHTML = 'Ver como pay';
                }
            });
            
            $('.filterControl').on('click', function() {
                  var from = document.getElementById('from').value;
                  var until = document.getElementById('until').value;
                  statuses = [];     
    
                  if (!from) {
                      Materialize.toast('<span class="toast-warning">Oops! Selecciona una fecha inicial.</span>',3500);
                      return false;
                  }
                  if (!until) {
                      Materialize.toast('<span class="toast-warning">Oops! Selecciona una fecha final.</span>',3500);
                      return false;
                  }
                  
                  var statusList = document.getElementsByClassName("filterStatus");
                  for (var i = 0, j = statusList.length;i<j;i++){
                      if(statusList[i].checked){
                        statuses.push("'" + statusList[i].id + "'");
                      }
                  }
                  destroyAndCreate(this.id);
            });
            
        });
    </script>
{% endblock %}