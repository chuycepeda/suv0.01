{% extends landing_layout %}

<!-- ADD PAGE HEAD ELEMENTS -->
{% block title %}<title>{{app_name}} » Lista de Reportes</title>{% endblock %}
   
{% block page_css %}
 	<link href="/{{theme}}/materialize/css/prism.css" type="text/css" rel="stylesheet" media="screen,projection">
    <link href="/{{theme}}/materialize/css/plugins/perfect-scrollbar/perfect-scrollbar.css" type="text/css" rel="stylesheet" media="screen,projection">
 	<link href="/{{theme}}/materialize/css/plugins/rrssb/rrssb.css" type="text/css" rel="stylesheet" media="screen,projection">
 	<link href="/{{theme}}/materialize/css/plugins/jquery/jquery.timelineMe.css" type="text/css" rel="stylesheet" media="screen,projection">
 	<style>
		.rating:hover{
			color:#ffc107!important;
			transform: scale(1.75);
			-webkit-transform: scale(1.75);
		}

		.rating{
			font-size: 30px;
			transform: scale(1.5);
			-webkit-transform: scale(1.5);
		} 

		.create{
			transition-timing-function: ease-in;
    		transition: border 0.3s;
    		-webkit-transition-timing-function: ease-in;
    		-webkit-transition: border 0.3s;
		}

		.create:hover{
			border-bottom: 6px solid {{brand_color}};
		}

		.chip {
		    display: inline-block;
		    height: 32px;
		    font-size: 13px;
		    font-weight: 500;
		    color: rgba(0, 0, 0, 0.6);
		    line-height: 32px;
		    padding: 0 12px;
		    border-radius: 16px;
		    background-color: #e4e4e4;
		}

		.hoverable:hover{
        	box-shadow: #A9A6A6 0px 8px 23px 6px;
        	transition: all .3s ease-out;
        }

        .hoverable{
        	transition: all .3s ease-out;
		}

		.image{
			-webkit-transform: scale(0.55);
			transform: scale(0.55);
			display: inline-block;
			vertical-align: top;
			width: 60px;
			height: 70px;
			max-width: 60px;
			max-height: 70px;
			border-radius: 3px;
			line-height: 60px;
			background-repeat: no-repeat;
			background-position: center;
		}
		.image:hover{
			-webkit-transform: scale(0.65);
			transform: scale(0.65);
		}

	    h3{
	      line-height: 60px;
	      letter-spacing: 0.2px;
	    }
 	</style>
{% endblock %}

{% block page_components %}
{% endblock %}


{% block header_content %}
<div class="parallax-container" style="max-height:200px;overflow:hidden;margin-bottom: -80px;">
	<div class="section no-pad-bot">
	  <div class="container">
	    <h2 class="header center brand-color-text" style="margin-top:85px;">Reportes</h2>        
	  </div>
	</div>
</div>
{% endblock %}

{% block body_content %}
	<div class="section">
		<div class="container" style="margin-top:80px">
			<div class="row">
		        <h3 class="col s12 m7 offset-m1 grey-text" style="font-weight: 200">Tu espacio digital para apoyar en la detección de problemas de infraestructura y recibir soluciones.</h3>
		        <div class="col card-panel s12 m2 white center create hoverable" style="padding-top: 30px;padding-bottom: 60px;cursor: pointer;" onclick='window.location = "{{uri_for('materialize-report-new')}}";'>
		          <h2 class="grey-text"><i class="mdi-maps-place" style="font-size:34px"></i></h2>
                  <h5 class="brand-color-text" style="font-family: roboto-thin;">Crea un reporte</h5>
                </div>
	    	</div>
	    	<div class="row">
		        <h5 class="col s12 m10 offset-m1 grey-text"> Cómo funciona</h5>
		        <div class="divider col s12 m10 offset-m1" style="margin-bottom:20px;"></div>
		        <div class="col s12 m10 offset-m1 center">
		        	<div class="col s12 m4">
		        		<img class="reponsive-img col s8 offset-s2" src="/{{theme}}/materialize/images/rep_1.png" alt="pet1">
		        		<h5 class="col s12 grey-text" style="font-weight: 200">I. Detectas un problema en la ciudad.</h5>
		        	</div>
		        	<div class="col s12 m4">
		        		<img class="reponsive-img col s8 offset-s2" src="/{{theme}}/materialize/images/rep_2.png" alt="pet2">
		        		<h5 class="col s12 grey-text" style="font-weight: 200">II. Creas un reporte y notificas.</h5>
		        	</div>
		        	<div class="col s12 m4">
		        		<img class="reponsive-img col s8 offset-s2" src="/{{theme}}/materialize/images/rep_3.png" alt="pet3">
		        		<h5 class="col s12 grey-text" style="font-weight: 200">III. Tu gobierno te soluciona.</h5>
		        	</div>
		        </div>
	    	</div>
			<div class="row">
				<h5 class="col s12 m10 offset-m1 grey-text"> Actividad</h5>
		        <div class="divider col s12 m10 offset-m1" style="margin-bottom:20px;"></div>
		        <div class="row">
	                <div class="col s12 m10 offset-m1 ">
	                   <a id="loadmore" class="waves-effect waves-light btn" style="display:none">Cargar siguientes reportes</a>
	                </div>
	                <div id="tl-meta" class="col s12 m10 offset-m1 ">
	                   <div id="timeline-container" class="row"></div>
	                </div>
				</div>

			</div>
		</div>
	</div>
{% endblock %}

{% block footer_content %}
{% endblock %}

{% block page_scripts %}
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true&libraries=places,visualization"></script>
	<script src="/{{theme}}/materialize/js/plugins/rrssb/rrssb.min.js"></script>
	<script src="/{{theme}}/materialize/js/plugins/jquery/jquery.timelineMe.js"></script>
	<script src="/{{theme}}/materialize/js/cartodb.js"></script>
	<script>
		var city_sql = new cartodb.SQL({ user: '{{cartodb_user}}' });
	    var city_table_name = '{{cartodb_reports_table}}';
        var reportDict;
		
		function getData(step,limit){
            var q = "Select * from "+city_table_name+" order by created desc offset "+step+" limit "+ limit;
            city_sql.execute(q).done(function(data) {
                console.log(data)
                var items = [];
                for (var i = 0; i < data.total_rows;i++){
                    var shrt = '<div class="container"><div class="card-content"><h4>'+data.rows[i].group_category+'</h4><div class="col s2"><span class="image " style="background-color:#'+reportDict[data.rows[i].group_category].color+'; -webkit-mask: url('+reportDict[data.rows[i].group_category].icon+') no-repeat 50% 50%;"></span></div><p class="col s10 truncate">'+data.rows[i].description+'</p><div class="chip white-text" style="margin-top: 20px;margin-left: 10px;">Ticket:'+data.rows[i].cartodb_id+'</div></div><div class="card-action center"><a class="grey-text maplink" href="{{uri_for('landing-map')}}?cdb_id='+data.rows[i].cartodb_id+'" target="_blank"><i class="mdi-maps-place"></i>Ver mapa</a></div></div>';
                    var full = '<div class="container"><div class="card-content"><h4>'+data.rows[i].group_category+'</h4><p class="col s12 valign-wrapper" style="padding:20px"><i class="mdi-image-style brand-color-text left"></i>Subcategoría: <span id="report_group_category" class="brand-secondary-color-text"> '+data.rows[i].sub_category+' </span></p><p class="col s12 valign-wrapper" style="padding:20px"><i class="mdi-action-description brand-color-text left"></i>Descripción:</p><div class="col s12"><blockquote class="grey-text text-lighten-1" style="margin-top: 10px; border-left-width: 5px; border-left-style: solid; border-left-color: rgb(221, 61, 161);">'+data.rows[i].description+'</blockquote></div></div>';
                    
                    var d = new Date(data.rows[i].created);
                    items.push({
                      type: 'smallItem',
                      label: d.getFullYear() + "-" + d.getMonth() + "-" + d.getDate()  + " " + d.getHours() + ":" + d.getMinutes(),
                      picto: '<a style="background-color: #'+reportDict[data.rows[i].group_category].color+';height: 250%;width: 250%;margin-left: -50%;margin-top: -55%;" class="image"></a>',
                      shortContent: shrt,
                      fullContent: full,
                      showMore: '<a class="btn-floating waves-effect waves-light blue right" style="right: 20px; "><i class="material-icons">add</i></a>',
                      showLess: '<a class="btn-floating waves-effect waves-light blue right" style="right: 20px; "><i class="material-icons">remove</i></a>'
                    });
                }
                $('#timeline-container').timelineMe({
                  labelClass: 'labelclass',
                  shortContentClass: 'card',
                  fullContentClass: 'card',
                  showMoreClass: 'row',
                  showLessClass: 'row',
                  items: items
                });
                Materialize.fadeInImage('#tl-meta');        
		    });
		}
		
		$(function() {
            var step = 0;
            var limit = 15;	
            var url = "{{uri_for('materialize-report-categories')}}";
        
            $.ajax({
                url: url,
                type: 'GET',
                success: function(data) { 
                    console.log(data)
                }
            }).done(function(data) {
                reportDict = data;
                getData(step,limit);
            });                
            
            $('#loadmore').click(function(){
                $('#tl-meta').empty();
                $('#tl-meta').append('<div id="timeline-container" class="row"></div>');
                step += 1;
                getData(step*limit, limit);
            });
        
        });
	</script>
{% endblock %}
