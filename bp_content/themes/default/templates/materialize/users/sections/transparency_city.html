{% extends landing_layout %}

<!-- ADD PAGE HEAD ELEMENTS -->
{% block title %}<title>{{app_name}} 禄 Conoce tu ciudad</title>{% endblock %}
   
{% block page_css %}
    <link href="/{{theme}}/materialize/css/plugins/perfect-scrollbar/perfect-scrollbar.css" type="text/css" rel="stylesheet" media="screen,projection">
 	<style>
		.rating:hover{
			color:#ffc107!important;
			transform: scale(1.75);
			-webkit-transform: scale(1.75);
		}

		.rating{
			font-size: 30px;
			transform: scale(1.5);
			-webkit-transform: scale(1.5);
		}

		.create{
			transition-timing-function: ease-in;
    		transition: border 0.3s;
    		-webkit-transition-timing-function: ease-in;
    		-webkit-transition: border 0.3s;
		}

		.create:hover{
			border-bottom: 6px solid {{brand_color}};
		}

		.chip {
		    display: inline-block;
		    height: 32px;
		    font-size: 13px;
		    font-weight: 500;
		    color: rgba(0, 0, 0, 0.6);
		    line-height: 32px;
		    padding: 0 12px;
		    border-radius: 16px;
		    background-color: #e4e4e4;
		}

		.hoverable:hover{
        	box-shadow: #A9A6A6 0px 8px 23px 6px;
        	transition: all .3s ease-out;
        }

        .hoverable{
        	transition: all .3s ease-out;
		}
 	</style>
{% endblock %}

{% block page_components %}
{% endblock %}

{% block body_content %}
	<div id="map">				
			</div>
			<div class="hide-on-small-only" style="width:270px; position:fixed; top:12%; left:3%;">
				<div>
	            	<input id="search_address" type="text" placeholder="Buscar direcci贸n... " onkeydown="if (event.keyCode == 13) codeAddress('search_address');" style="    background-color: white;border-radius: 4px;line-height: 20px;text-align: center;box-shadow: 0 1px 0 0 white!important;border: 1px solid white!important;padding-left: 12px;padding-right: 12px;width: 244px!important;">
				</div>
                <ul class="collapsible collapsible-accordion" data-collapsible="expandable">
                  <li>
                    <div class="collapsible-header white-text truncate brand-secondary-color"> <i class="mdi-maps-layers"></i> Capas de informaci贸n.</div>
	                    <div class="collapsible-body white">
	                    	<p style="padding: 8px;">
		                    	<input type="checkbox" class="filled-in layerControl" id="check_polygon" checked>
		                    	<label for="check_polygon">Pol铆gono territorial</label>
		                    </p>
		                    <p style="padding: 8px;">
		                    	<input type="checkbox" class="filled-in layerControl" id="1">
		                    	<label for="1">Secciones electorales</label>
		                    </p>
		                    <p style="padding: 8px;">
		                    	<input type="checkbox" class="filled-in layerControl" id="2">
		                    	<label for="2">Distritos electorales</label>
		                    </p>
		                    <p style="padding: 8px;">
		                    	<input type="checkbox" class="filled-in layerControl" id="3" checked>
		                    	<label for="3">Unidades econ贸micas</label>
		                    </p>
		                    <p style="padding: 8px;">
		                    	<input type="checkbox" class="filled-in layerControl" id="4">
		                    	<label for="4">AGEBs urbanos - Vivienda</label>
		                    </p>
		                    <p style="padding: 8px;">
		                    	<input type="checkbox" class="filled-in layerControl" id="5">
		                    	<label for="5">AGEBs urbanos - Poblaci贸n</label>
		                    </p>
		                    <p style="padding: 8px;">
		                    	<input type="checkbox" class="filled-in layerControl" id="6">
		                    	<label for="6">AGEBs urbanos - Educaci贸n</label>
		                    </p>
		                    <p style="padding: 8px;">
		                    	<input type="checkbox" class="filled-in layerControl" id="7">
		                    	<label for="7">AGEBs urbanos - Econom铆a</label>
		                    </p>
	                    </div>
                  </li>
                </ul>
            </div> 
{% endblock %}

{% block page_scripts %}
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=drawing,places,panoramio,weather,visualization"></script>
	<script src="/{{theme}}/materialize/js/cartodb.js"></script>
    <script type="text/javascript">
    	// cartodb
    	var city_user = '{{cartodb_user}}';
    	var city_table_name = '{{cartodb_reports_table}}';
    	var city_mun_table_name = '{{cartodb_polygon_table}}';
    	var city_polygon_full_name = '{{cartodb_polygon_full_name}}';
    	var city_polygon_name = '{{cartodb_polygon_name}}'
		var city_sql = new cartodb.SQL({ user: '{{cartodb_user}}' });
		var sublayers = [];
        
		/* MAPS RELATED */
		var panorama, sv = new google.maps.StreetViewService();
		var mapCenter = [{{lat}},{{lng}}] , map;
		google.maps.event.addDomListener(window,'load', init);
        var query;                    
		
		function init(){
			var mapOptions = {
				center: new google.maps.LatLng(mapCenter[0], mapCenter[1]),
				zoom: {% if is_mobile %}10{% else %}12{% endif %},
				minZoom:5,
				zoomControl: true,
				zoomControlOptions: {
					style: google.maps.ZoomControlStyle.SMALL,	
					position: google.maps.ControlPosition.LEFT_BOTTOM	
				},
				mapTypeControl: false,
				scrollwheel: false,
				streetViewControl: true,
				streetViewControlOptions: {
					position: google.maps.ControlPosition.LEFT_BOTTOM	
				},
				panControl:false,
				backgroundColor: 'rgb(249, 249, 249)',
				rotateControl:true,
				overviewMapControl:true
			};
			map = new google.maps.Map(document.getElementById('map'), mapOptions);
			
			google.maps.event.addDomListener(window, 'resize', function() {
                map.setCenter({lat: mapCenter[0], lng: mapCenter[1]});
            });

            var autocomplete_from = new google.maps.places.Autocomplete(document.getElementById('search_address'))
			autocomplete_from.bindTo('bounds', map);
			google.maps.event.addListener(autocomplete_from, 'place_changed', function() {
			    var place = autocomplete_from.getPlace();
			    if (place.geometry.viewport) {
			      map.fitBounds(place.geometry.viewport);
			    }else{
			      map.setCenter(place.geometry.location);
			      map.setZoom(17);
			    }
			});	

            var centerControlDiv = document.createElement('div');
			var centerControl = new CenterControl(centerControlDiv, map);
			centerControlDiv.index = 1;
			map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(centerControlDiv);


			// CITY LAYERS
			layerSource = {
                user_name: city_user,
                type: 'cartodb',
                sublayers: [{
                    sql: "SELECT " + city_mun_table_name + ".* FROM " + city_mun_table_name + " WHERE " + city_mun_table_name + ".name IN ('" + city_polygon_name + "')",
                    cartocss: "#" + city_mun_table_name + "{line-color: {{brand_secondary_color}};line-width: 3;line-opacity: 1;}"
                }]
            };
            cartodb.createLayer(map,layerSource)
            .on('done', function(layer) {
			    map.overlayMapTypes.setAt(0, layer);
                for (var i = 0; i < layer.getSubLayerCount(); i++) {
                   sublayers[i] = layer.getSubLayer(i);
                   console.log("Congrats, you added sublayer #" + i + "!");
                }
            }); 


            // MEXICO LAYERS
			layerSource = {
                user_name: 'mexico',
                type: 'cartodb',
                sublayers: [{
                    sql: "SELECT nl_secciones.* FROM nl_secciones, pais_municipios WHERE ST_Intersects(nl_secciones.the_geom, pais_municipios.the_geom) AND pais_municipios.nom_mun IN ('" + city_polygon_full_name + "')",
                    cartocss: "#nl_secciones{line-color: #FFD528;line-width: 3;line-opacity: 1;}",
                    interactivity: ["clavegeo","entidad","distrito","pobtot","pobmas","pobfem","p_0a2","p_0a2_m","p_0a2_f","p_3ymas","p_3ymas_m","p_3ymas_f","p_5ymas","p_5ymas_m","p_5ymas_f","p_12ymas","p_12ymas_m","p_12ymas_f","p_15ymas","p_15ymas_m","p_15ymas_f","p_18ymas","p_18ymas_m","p_18ymas_f","p_3a5","p_3a5_m","p_3a5_f","p_6a11","p_6a11_m","p_6a11_f","p_8a14","p_8a14_m","p_8a14_f","p_12a14","p_12a14_m","p_12a14_f","p_15a17","p_15a17_m","p_15a17_f","p_18a24","p_18a24_m","p_18a24_f","p_15a49_f","p_60ymas","p_60ymas_m","p_60ymas_f","rel_h_m","pob0_14","pob15_64","pob65_mas","prom_hnv","pnacent","pnacent_m","pnacent_f","pnacoe","pnacoe_m","pnacoe_f","pres2005","pres2005_m","pres2005_f","presoe05","presoe05_m","presoe05_f","p3ym_hli","p3ym_hli_m","p3ym_hli_f","p3hlinhe","p3hlinhe_m","p3hlinhe_f","p3hli_he","p3hli_he_m","p3hli_he_f","p5_hli","p5_hli_nhe","p5_hli_he","phog_ind","pcon_lim","pclim_mot","pclim_vis","pclim_leng","pclim_aud","pclim_mot2","pclim_men","pclim_men2","psin_lim","p3a5_noa","p3a5_noa_m","p3a5_noa_f","p6a11_noa","p6a11_noam","p6a11_noaf","p12a14noa","p12a14noam","p12a14noaf","p15a17a","p15a17a_m","p15a17a_f","p18a24a","p18a24a_m","p18a24a_f","p8a14an","p8a14an_m","p8a14an_f","p15ym_an","p15ym_an_m","p15ym_an_f","p15ym_se","p15ym_se_m","p15ym_se_f","p15pri_in","p15pri_inm","p15pri_inf","p15pri_co","p15pri_com","p15pri_cof","p15sec_in","p15sec_inm","p15sec_inf","p15sec_co","p15sec_com","p15sec_cof","p18ym_pb","p18ym_pb_m","p18ym_pb_f","graproes","graproes_m","graproes_f","pea","pea_m","pea_f","pe_inac","pe_inac_m","pe_inac_f","pocupada","pocupada_m","pocupada_f","pdesocup","pdesocup_m","pdesocup_f","psinder","pder_ss","pder_imss","pder_iste","pder_istee","pder_segp","p12ym_solt","p12ym_casa","p12ym_sepa","pcatolica","pncatolica","potras_rel","psin_relig","tothog","hogjef_m","hogjef_f","pobhog","phogjef_m","phogjef_f","vivtot","tvivhab"]
                },{
                    sql: "SELECT nl_distritos.* FROM nl_distritos, pais_municipios WHERE ST_Intersects(nl_distritos.the_geom, pais_municipios.the_geom) AND pais_municipios.nom_mun IN ('" + city_polygon_full_name + "')",
                    cartocss: "#nl_distritos{line-color: #FFAB1F;line-width: 3;line-opacity: 1;}",
                    interactivity: ["p_18a24_m","p_18a24_f","p_15a49_f","p_60ymas","p_60ymas_m","p_60ymas_f","rel_h_m","pob0_14","pob15_64","pob65_mas","prom_hnv","pnacent","pnacent_m","pnacent_f","pnacoe","pnacoe_m","pnacoe_f","pres2005","pres2005_m","pres2005_f","presoe05","presoe05_m","presoe05_f","p3ym_hli","p3ym_hli_m","p3ym_hli_f","p3hlinhe","p3hlinhe_m","p3hlinhe_f","p3hli_he","p3hli_he_m","p3hli_he_f","p5_hli","p5_hli_nhe","p5_hli_he","phog_ind","pcon_lim","pclim_mot","pclim_vis","pclim_leng","pclim_aud","pclim_mot2","pclim_men","pclim_men2","psin_lim","p3a5_noa","p3a5_noa_m","p3a5_noa_f","p6a11_noa","p6a11_noam","p6a11_noaf","p12a14noa","p12a14noam","p12a14noaf","p15a17a","p15a17a_m","p15a17a_f","p18a24a","p18a24a_m","p18a24a_f","p8a14an","p8a14an_m","p8a14an_f","p15ym_an","p15ym_an_m","p15ym_an_f","p15ym_se","p15ym_se_m","p15ym_se_f","p15pri_in","p15pri_inm","p15pri_inf","p15pri_co","p15pri_com","p15pri_cof","p15sec_in","p15sec_inm","p15sec_inf","p15sec_co","p15sec_com","p15sec_cof","p18ym_pb","p18ym_pb_m","p18ym_pb_f","graproes","graproes_m","graproes_f","pea","pea_m","pea_f","pe_inac","pe_inac_m","pe_inac_f","pocupada","pocupada_m","pocupada_f","pdesocup","pdesocup_m","pdesocup_f","psinder","pder_ss","pder_imss","pder_iste","pder_istee","pder_segp","p12ym_solt","p12ym_casa","p12ym_sepa","pcatolica","pncatolica","potras_rel","psin_relig","tothog","hogjef_m","hogjef_f","pobhog","phogjef_m","phogjef_f","vivtot","tvivhab","tvivpar","vivpar_hab","tvivparhab","vivpar_des","vivpar_ut","ocupvivpar","prom_ocup","pro_ocup_c","vph_pisodt","vph_pisoti","vph_1dor","vph_2ymasd","vph_1cuart","vph_2cuart","vph_3ymasc","vph_c_elec","vph_s_elec","vph_aguadv","vph_aguafv","vph_excsa","vph_drenaj","vph_nodren","vph_c_serv","vph_snbien","vph_radio","vph_tv","vph_refri","vph_lavad","vph_autom","vph_pc","vph_telef","vph_cel","vph_inter","cartodb_id","the_geom","the_geom_webmercator","created_at","updated_at"]
                },{
                    sql: "SELECT nl_denue.* FROM nl_denue, pais_municipios WHERE ST_Intersects(nl_denue.the_geom, pais_municipios.the_geom) AND pais_municipios.nom_mun IN ('" + city_polygon_full_name + "')",
                    cartocss: "#nl_denue{marker-fill: #FF7E15;marker-line-color: #FFFFFF; line-width: 3;line-opacity: 1;}",
                    interactivity: ["nom_vial","nombre_act","numero_ext","numero_int","per_ocu","raz_social","tipo_asent","tipo_vial","tipocencom","cartodb_id","id","nom_estab","codigo_act","edificio","nom_asent","nom_cencom","the_geom","num_local","cod_postal","cve_ent","entidad","cve_mun","municipio","cve_loc","localidad","ageb","manzana","telefono","correoelec","www","tipounieco","latitud","longitud","fecha_alta","created_at","the_geom_webmercator","updated_at"]
                },{
                    sql: "SELECT nl_ageb_urb_viv.* FROM nl_ageb_urb_viv, pais_municipios WHERE ST_Intersects(nl_ageb_urb_viv.the_geom, pais_municipios.the_geom) AND pais_municipios.nom_mun IN ('" + city_polygon_full_name + "')",
                    cartocss: "#nl_ageb_urb_viv{line-color: #69B1D8;line-width: 3;line-opacity: 1;}",
                    interactivity: ["cvegeo","viv0","viv1","viv2","viv2_r","viv3","viv3_r","viv4_r","viv5_r","viv6","viv6_r","viv7","viv7_r","viv8","viv8_r","viv9","viv9_r","viv10","viv10_r","viv11","viv11_r","viv12","viv12_r","viv13","viv13_r","viv14","viv14_r","viv15","viv15_r","viv16","viv16_r","viv17","viv17_r","viv18","viv18_r","viv19","viv19_r","viv20","viv20_r","viv21","viv21_r","viv22","viv22_r","viv23","viv23_r","viv24","viv24_r","viv25","viv25_r","viv26","viv26_r","viv27","viv27_r","viv28","viv28_r","viv29","viv29_r","viv30","viv30_r","viv31","viv31_r","viv32","viv32_r","viv33","viv33_r","viv34","viv34_r","viv35","viv35_r","viv36","viv36_r","viv37","viv37_r","viv38","viv38_r","viv39","viv39_r","viv40","viv40_r","viv41","viv41_r","the_geom","cartodb_id","created_at","updated_at","the_geom_webmercator"]
                },{
                    sql: "SELECT nl_ageb_urb_pob.* FROM nl_ageb_urb_pob, pais_municipios WHERE ST_Intersects(nl_ageb_urb_pob.the_geom, pais_municipios.the_geom) AND pais_municipios.nom_mun IN ('" + city_polygon_full_name + "')",
                    cartocss: "#nl_ageb_urb_pob{line-color: #3A6698;line-width: 3;line-opacity: 1;}",
                    interactivity: ["the_geom","cartodb_id","cvegeo","pob1","pob2","pob2_r","pob3","pob3_r","pob4","pob4_r","pob5","pob5_r","pob6","pob6_r","pob7","pob7_r","pob8","pob8_r","pob9","pob9_r","pob10","pob10_r","pob11","pob11_r","pob12","pob12_r","pob13","pob13_r","pob14","pob14_r","pob15","pob15_r","pob16","pob16_r","pob17","pob17_r","pob18","pob18_r","pob19","pob19_r","pob20","pob20_r","pob21","pob21_r","pob22","pob22_r","pob23","pob23_r","pob24","pob24_r","pob25","pob25_r","pob26_r","pob27_r","pob28_r","pob29_r","pob30_r","pob31","pob31_r","pob32","pob32_r","pob33","pob33_r","pob34","pob34_r","pob35","pob35_r","pob36","pob36_r","pob37","pob37_r","pob38","pob38_r","pob39","pob39_r","pob40","pob40_r","pob41","pob41_r","pob42","pob42_r","pob43","pob43_r","pob44","pob44_r","pob45","pob45_r","pob46","pob46_r","pob47","pob47_r","pob48","pob48_r","pob49","pob49_r","pob50","pob50_r","pob51","pob51_r","pob52","pob52_r","pob53","pob53_r","pob54","pob54_r","pob55","pob55_r","pob56","pob56_r","pob57","pob57_r","pob58","pob58_r","pob59","pob59_r","pob60","pob60_r","pob61","pob61_r","pob62","pob62_r","pob63","pob63_r","pob64","pob64_r","pob65","pob65_r","pob66","pob66_r","pob67","pob67_r","pob68","pob68_r","pob69","pob69_r","pob70","pob70_r","pob71","pob71_r","pob72","pob72_r","pob73","pob73_r","pob74","pob74_r","pob75","pob75_r","pob76","pob76_r","pob77","pob77_r","pob78","pob78_r","pob79","pob79_r","pob80","pob80_r","pob81","pob81_r","oid_"]
                },{
                    sql: "SELECT nl_ageb_urb_edu.* FROM nl_ageb_urb_edu, pais_municipios WHERE ST_Intersects(nl_ageb_urb_edu.the_geom, pais_municipios.the_geom) AND pais_municipios.nom_mun IN ('" + city_polygon_full_name + "')",
                    cartocss: "#nl_ageb_urb_edu{line-color: #BA58DA;line-width: 3;line-opacity: 1;}",
                    interactivity: ["cartodb_id","cvegeo","edu1","edu1_r","edu4","edu4_r","edu7","edu7_r","edu10","edu10_r","edu13","edu13_r","edu16","edu16_r","edu19","edu19_r","edu22","edu22_r","edu25","edu25_r","edu28","edu28_r","edu31","edu31_r","edu34","edu34_r","edu37","edu37_r","edu40","edu40_r","edu43","edu43_r","edu46","edu46_r","edu49_r","edu50_r","edu51_r","the_geom","created_at","updated_at","the_geom_webmercator"]
                },{
                    sql: "SELECT nl_ageb_urb_eco.* FROM nl_ageb_urb_eco, pais_municipios WHERE ST_Intersects(nl_ageb_urb_eco.the_geom, pais_municipios.the_geom) AND pais_municipios.nom_mun IN ('" + city_polygon_full_name + "')",
                    cartocss: "#nl_ageb_urb_eco{line-color: #56107E;line-width: 3;line-opacity: 1;}",
                    interactivity: ["cvegeo","eco1","eco1_r","eco2","eco2_r","eco3","eco3_r","eco4","eco4_r","eco5","eco5_r","eco6","eco6_r","eco7","eco7_r","eco10","eco10_r","eco13","eco13_r","eco16","eco16_r","eco19","eco19_r","eco22","eco22_r","eco25","eco25_r","eco26","eco26_r","eco27","eco27_r","eco28","eco28_r","eco29","eco29_r","eco30","eco30_r","eco31","eco31_r","eco34","eco34_r","eco37","eco37_r","eco40","eco40_r","eco43","eco43_r","the_geom","created_at","cartodb_id","updated_at","the_geom_webmercator"]
                }]
            };
            cartodb.createLayer(map,layerSource)
            .on('done', function(layer) {
			    map.overlayMapTypes.setAt(1, layer);
                for (var i = 1, j =0; j < layer.getSubLayerCount(); i++, j++) {
                   sublayers[i] = layer.getSubLayer(j);
				   sublayers[i].setInteraction(true);                                 

                   if (i != 3) sublayers[i].hide(); //leave just one turned on.
                   console.log("Congrats, you added sublayer #" + i + "!");
                }
            }); 


            $('.layerControl').change(function() {
                if (this.id == 'check_polygon'){
                    if (this.checked) sublayers[0].show();
                    else sublayers[0].hide();
                }else{
                	if (this.checked) sublayers[parseInt(this.id)].show();
                    else sublayers[parseInt(this.id)].hide();
                }
            });
			   
		}

		function codeAddress(input) {
	        var address, obj;	     				        

            address = document.getElementById(input).value;
            obj = { 'address': address };
	        geocoder.geocode( obj, function(results, status) {
	            if (status == google.maps.GeocoderStatus.OK) {
	                
	                if (typeof(input) === 'string') {
	                    map.setCenter(results[0].geometry.location);
	                    switch (results[0].geometry.location_type){
	                        case 'ROOFTOP': map.setZoom(17); break;
	                        case 'RANGE_INTERPOLATED': map.setZoom(16); break;
	                        case 'GEOMETRIC_CENTER': map.setZoom(15); break;
	                        case 'APPROXIMATE': map.setZoom(13); break;
	                    }
	                }else{
	                    if (results[1]) {
	                        document.getElementById(input).value = results[1].formatted_address;
	                    } else {
	                        console.log('No results found');
	                    }
	                }
	            
	            } else {
	                console.log('Geocode was not successful for the following reason: ' + status);
	            }
	        });
	    }

		function CenterControl(controlDiv, map) {
			// Set CSS for the control border.
			var controlUI = document.createElement('div');
			controlUI.style.backgroundColor = '#fff';
			controlUI.style.border = '2px solid #fff';
			controlUI.style.borderRadius = '3px';
			controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
			controlUI.style.cursor = 'pointer';
			controlUI.style.marginBottom = '2px';
			controlUI.style.marginLeft = '10px';
			controlUI.style.textAlign = 'center';
			controlUI.title = 'Click to locate you.';
			controlDiv.appendChild(controlUI);

			// Set CSS for the control interior.
			var controlText = document.createElement('div');
			controlText.style.color = 'rgb(25,25,25)';
			controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
			controlText.style.fontSize = '16px';
			controlText.style.lineHeight = '15px';
			controlText.innerHTML = '<i class="mdi-maps-my-location grey-text text-darken-1" style="font-size:20px; padding:3px;"></i>';
			controlUI.appendChild(controlText);

			// Setup the click event listeners: simply set the map to Chicago.
			controlUI.addEventListener('click', function() {
				$('#main-preloader').show();
				if (navigator.geolocation) {
			        navigator.geolocation.getCurrentPosition(mapGoPosition);
			    } else {
	            	Materialize.toast('<span class="toast-warning">Oops! This navigator has no support for locating you.</span>',4500);
					$('#main-preloader').hide();
			    }
			});
		}

		function mapGoPosition(position) {
		    map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
		    map.setZoom(16);
			$('#main-preloader').hide();
		}

		function getUrlVars(){
		    var vars = [], hash;
		    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
		    for(var i = 0; i < hashes.length; i++)
		    {
		        hash = hashes[i].split('=');
		        vars.push(hash[0]);
		        vars[hash[0]] = hash[1];
		        if (vars[hash[0]]) if (vars[hash[0]].search(/#/) != -1) vars[hash[0]]=vars[hash[0]].substr(0,vars[hash[0]].search(/#/));
		    }
		    return vars;
		}
			
        function addCommas(val) {
		  	while (/(\d+)(\d{3})/.test(val.toString())) {
		  		var val = val.toString().replace(/(\d+)(\d{3})/, '$1' + ',' + '$2');
		  	}
		  	return val;
		}				
	</script>
{% endblock %}
